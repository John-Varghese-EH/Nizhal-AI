const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./GLTFLoader-SeKim6zn.js","./three-xLF7kgIl.js","./react-vendor-DIqo-C3o.js","./animation-Bl1i2YEf.js","./three-vrm.module-Btd07GQG.js"])))=>i.map(i=>d[i]);
import{c as Dt,_ as dt}from"./globals-B0QoFA28.js";import{j as H}from"./animation-Bl1i2YEf.js";import{a as m}from"./react-vendor-DIqo-C3o.js";import{u as Mt,a as Et,V as X,D as Ot,f as _t,g as Tt,O as vt,M as K,h as Lt,i as Ft,j as Ct,Q as Bt,k as Ut,l as kt,m as Wt,E as jt,N as $t,n as Kt,C as qt,e as Yt,T as Zt}from"./three-xLF7kgIl.js";import{r as Qt,c as xt,g as Xt,A as _}from"./character-Bp-iGwNr.js";import{_ as Jt,O as te}from"./OrbitControls-ChSUc3J3.js";const J=new X,ft=new X,ee=new X,Pt=new _t;function ie(l,t,e){const i=J.setFromMatrixPosition(l.matrixWorld);i.project(t);const n=e.width/2,s=e.height/2;return[i.x*n+n,-(i.y*s)+s]}function ne(l,t){const e=J.setFromMatrixPosition(l.matrixWorld),i=ft.setFromMatrixPosition(t.matrixWorld),n=e.sub(i),s=t.getWorldDirection(ee);return n.angleTo(s)>Math.PI/2}function se(l,t,e,i){const n=J.setFromMatrixPosition(l.matrixWorld),s=n.clone();s.project(t),Pt.set(s.x,s.y),e.setFromCamera(Pt,t);const a=e.intersectObjects(i,!0);if(a.length){const c=a[0].distance;return n.distanceTo(e.ray.origin)<c}return!0}function oe(l,t){if(t instanceof vt)return t.zoom;if(t instanceof Tt){const e=J.setFromMatrixPosition(l.matrixWorld),i=ft.setFromMatrixPosition(t.matrixWorld),n=t.fov*Math.PI/180,s=e.distanceTo(i);return 1/(2*Math.tan(n/2)*s)}else return 1}function re(l,t,e){if(t instanceof Tt||t instanceof vt){const i=J.setFromMatrixPosition(l.matrixWorld),n=ft.setFromMatrixPosition(t.matrixWorld),s=i.distanceTo(n),a=(e[1]-e[0])/(t.far-t.near),c=e[1]-a*t.far;return Math.round(a*s+c)}}const mt=l=>Math.abs(l)<1e-10?0:l;function wt(l,t,e=""){let i="matrix3d(";for(let n=0;n!==16;n++)i+=mt(t[n]*l.elements[n])+(n!==15?",":")");return e+i}const ae=(l=>t=>wt(t,l))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),le=(l=>(t,e)=>wt(t,l(e),"translate(-50%,-50%)"))(l=>[1/l,1/l,1/l,1,-1/l,-1/l,-1/l,-1,1/l,1/l,1/l,1,1,1,1,1]);function ce(l){return l&&typeof l=="object"&&"current"in l}const ue=m.forwardRef(({children:l,eps:t=.001,style:e,className:i,prepend:n,center:s,fullscreen:a,portal:c,distanceFactor:u,sprite:o=!1,transform:h=!1,occlude:d,onOcclude:g,castShadow:p,receiveShadow:A,material:z,geometry:k,zIndexRange:b=[16777271,0],calculatePosition:S=ie,as:nt="div",wrapperClass:O,pointerEvents:F="auto",...E},q)=>{const{gl:w,camera:x,scene:M,size:R,raycaster:P,events:T,viewport:N}=Mt(),[f]=m.useState(()=>document.createElement(nt)),Y=m.useRef(null),v=m.useRef(null),G=m.useRef(0),I=m.useRef([0,0]),Z=m.useRef(null),st=m.useRef(null),W=(c==null?void 0:c.current)||T.connected||w.domElement.parentNode,D=m.useRef(null),tt=m.useRef(!1),et=m.useMemo(()=>d&&d!=="blending"||Array.isArray(d)&&d.length&&ce(d[0]),[d]);m.useLayoutEffect(()=>{const L=w.domElement;d&&d==="blending"?(L.style.zIndex=`${Math.floor(b[0]/2)}`,L.style.position="absolute",L.style.pointerEvents="none"):(L.style.zIndex=null,L.style.position=null,L.style.pointerEvents=null)},[d]),m.useLayoutEffect(()=>{if(v.current){const L=Y.current=Dt.createRoot(f);if(M.updateMatrixWorld(),h)f.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const y=S(v.current,x,R);f.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${y[0]}px,${y[1]}px,0);transform-origin:0 0;`}return W&&(n?W.prepend(f):W.appendChild(f)),()=>{W&&W.removeChild(f),L.unmount()}}},[W,h]),m.useLayoutEffect(()=>{O&&(f.className=O)},[O]);const gt=m.useMemo(()=>h?{position:"absolute",top:0,left:0,width:R.width,height:R.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:s?"translate3d(-50%,-50%,0)":"none",...a&&{top:-R.height/2,left:-R.width/2,width:R.width,height:R.height},...e},[e,s,a,R,h]),It=m.useMemo(()=>({position:"absolute",pointerEvents:F}),[F]);m.useLayoutEffect(()=>{if(tt.current=!1,h){var L;(L=Y.current)==null||L.render(m.createElement("div",{ref:Z,style:gt},m.createElement("div",{ref:st,style:It},m.createElement("div",{ref:q,className:i,style:e,children:l}))))}else{var y;(y=Y.current)==null||y.render(m.createElement("div",{ref:q,style:gt,className:i,children:l}))}});const j=m.useRef(!0);Et(L=>{if(v.current){x.updateMatrixWorld(),v.current.updateWorldMatrix(!0,!1);const y=h?I.current:S(v.current,x,R);if(h||Math.abs(G.current-x.zoom)>t||Math.abs(I.current[0]-y[0])>t||Math.abs(I.current[1]-y[1])>t){const C=ne(v.current,x);let V=!1;et&&(Array.isArray(d)?V=d.map(B=>B.current):d!=="blending"&&(V=[M]));const Q=j.current;if(V){const B=se(v.current,x,P,V);j.current=B&&!C}else j.current=!C;Q!==j.current&&(g?g(!j.current):f.style.display=j.current?"block":"none");const it=Math.floor(b[0]/2),zt=d?et?[b[0],it]:[it-1,0]:b;if(f.style.zIndex=`${re(v.current,x,zt)}`,h){const[B,Rt]=[R.width/2,R.height/2],ot=x.projectionMatrix.elements[5]*Rt,{isOrthographicCamera:yt,top:St,left:bt,bottom:Gt,right:Ht}=x,Vt=ae(x.matrixWorldInverse),Nt=yt?`scale(${ot})translate(${mt(-(Ht+bt)/2)}px,${mt((St+Gt)/2)}px)`:`translateZ(${ot}px)`;let U=v.current.matrixWorld;o&&(U=x.matrixWorldInverse.clone().transpose().copyPosition(U).scale(v.current.scale),U.elements[3]=U.elements[7]=U.elements[11]=0,U.elements[15]=1),f.style.width=R.width+"px",f.style.height=R.height+"px",f.style.perspective=yt?"":`${ot}px`,Z.current&&st.current&&(Z.current.style.transform=`${Nt}${Vt}translate(${B}px,${Rt}px)`,st.current.style.transform=le(U,1/((u||10)/400)))}else{const B=u===void 0?1:oe(v.current,x)*u;f.style.transform=`translate3d(${y[0]}px,${y[1]}px,0) scale(${B})`}I.current=y,G.current=x.zoom}}if(!et&&D.current&&!tt.current)if(h){if(Z.current){const y=Z.current.children[0];if(y!=null&&y.clientWidth&&y!=null&&y.clientHeight){const{isOrthographicCamera:C}=x;if(C||k)E.scale&&(Array.isArray(E.scale)?E.scale instanceof X?D.current.scale.copy(E.scale.clone().divideScalar(1)):D.current.scale.set(1/E.scale[0],1/E.scale[1],1/E.scale[2]):D.current.scale.setScalar(1/E.scale));else{const V=(u||10)/400,Q=y.clientWidth*V,it=y.clientHeight*V;D.current.scale.set(Q,it,1)}tt.current=!0}}}else{const y=f.children[0];if(y!=null&&y.clientWidth&&y!=null&&y.clientHeight){const C=1/N.factor,V=y.clientWidth*C,Q=y.clientHeight*C;D.current.scale.set(V,Q,1),tt.current=!0}D.current.lookAt(L.camera.position)}});const pt=m.useMemo(()=>({vertexShader:h?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[h]);return m.createElement("group",Jt({},E,{ref:v}),d&&!et&&m.createElement("mesh",{castShadow:p,receiveShadow:A,ref:D},k||m.createElement("planeGeometry",null),z||m.createElement("shaderMaterial",{side:Ot,vertexShader:pt.vertexShader,fragmentShader:pt.fragmentShader})))}),r={HIPS:"hips",SPINE:"spine",CHEST:"chest",UPPER_CHEST:"upperChest",NECK:"neck",HEAD:"head",LEFT_SHOULDER:"leftShoulder",LEFT_UPPER_ARM:"leftUpperArm",LEFT_LOWER_ARM:"leftLowerArm",LEFT_HAND:"leftHand",RIGHT_SHOULDER:"rightShoulder",RIGHT_UPPER_ARM:"rightUpperArm",RIGHT_LOWER_ARM:"rightLowerArm",RIGHT_HAND:"rightHand",LEFT_UPPER_LEG:"leftUpperLeg",LEFT_LOWER_LEG:"leftLowerLeg",LEFT_FOOT:"leftFoot",RIGHT_UPPER_LEG:"rightUpperLeg",RIGHT_LOWER_LEG:"rightLowerLeg",RIGHT_FOOT:"rightFoot"},rt={idle:{name:"idle",duration:.5,bones:{[r.LEFT_UPPER_ARM]:{x:0,y:0,z:.3},[r.RIGHT_UPPER_ARM]:{x:0,y:0,z:-.3},[r.LEFT_LOWER_ARM]:{x:0,y:0,z:0},[r.RIGHT_LOWER_ARM]:{x:0,y:0,z:0},[r.LEFT_HAND]:{x:0,y:0,z:.1},[r.RIGHT_HAND]:{x:0,y:0,z:-.1},[r.LEFT_UPPER_LEG]:{x:0,y:0,z:0},[r.RIGHT_UPPER_LEG]:{x:0,y:0,z:0},[r.SPINE]:{x:0,y:0,z:0},[r.HEAD]:{x:0,y:0,z:0}}},sitting:{name:"sitting",duration:.8,bones:{[r.LEFT_UPPER_ARM]:{x:.2,y:0,z:.5},[r.RIGHT_UPPER_ARM]:{x:.2,y:0,z:-.5},[r.LEFT_LOWER_ARM]:{x:-.8,y:0,z:0},[r.RIGHT_LOWER_ARM]:{x:-.8,y:0,z:0},[r.LEFT_UPPER_LEG]:{x:-1.57,y:.1,z:0},[r.RIGHT_UPPER_LEG]:{x:-1.57,y:-.1,z:0},[r.LEFT_LOWER_LEG]:{x:1.57,y:0,z:0},[r.RIGHT_LOWER_LEG]:{x:1.57,y:0,z:0},[r.SPINE]:{x:-.1,y:0,z:0},[r.HEAD]:{x:.05,y:0,z:0}}},waving:{name:"waving",duration:.4,isGesture:!0,returnToIdle:!0,gestureDuration:2,bones:{[r.RIGHT_UPPER_ARM]:{x:0,y:0,z:-2.5},[r.RIGHT_LOWER_ARM]:{x:-.8,y:0,z:0},[r.RIGHT_HAND]:{x:0,y:0,z:0},[r.HEAD]:{x:0,y:.15,z:.05}}},stretching:{name:"stretching",duration:.6,isGesture:!0,returnToIdle:!0,gestureDuration:3,bones:{[r.LEFT_UPPER_ARM]:{x:0,y:.3,z:2.8},[r.RIGHT_UPPER_ARM]:{x:0,y:-.3,z:-2.8},[r.LEFT_LOWER_ARM]:{x:0,y:0,z:0},[r.RIGHT_LOWER_ARM]:{x:0,y:0,z:0},[r.SPINE]:{x:.15,y:0,z:0},[r.HEAD]:{x:-.2,y:0,z:0}}},lookingAround:{name:"lookingAround",duration:.4,isGesture:!0,returnToIdle:!0,gestureDuration:3,bones:{[r.HEAD]:{x:0,y:.15,z:0},[r.NECK]:{x:0,y:.08,z:0}},animation:{type:"sequence",keyframes:[{time:0,bones:{[r.HEAD]:{y:0}}},{time:.3,bones:{[r.HEAD]:{y:.2}}},{time:.6,bones:{[r.HEAD]:{y:0}}},{time:.9,bones:{[r.HEAD]:{y:-.2}}},{time:1,bones:{[r.HEAD]:{y:0}}}]}},sleeping:{name:"sleeping",duration:1,bones:{[r.HEAD]:{x:.3,y:.1,z:.15},[r.NECK]:{x:.1,y:0,z:0},[r.SPINE]:{x:.1,y:0,z:.05},[r.LEFT_UPPER_ARM]:{x:.3,y:0,z:.5},[r.RIGHT_UPPER_ARM]:{x:.3,y:0,z:-.5},[r.LEFT_LOWER_ARM]:{x:-.4,y:0,z:0},[r.RIGHT_LOWER_ARM]:{x:-.4,y:0,z:0}}},dancing:{name:"dancing",duration:.3,bones:{[r.LEFT_UPPER_ARM]:{x:0,y:.3,z:1.2},[r.RIGHT_UPPER_ARM]:{x:0,y:-.3,z:-1.2},[r.LEFT_LOWER_ARM]:{x:-1,y:0,z:0},[r.RIGHT_LOWER_ARM]:{x:-1,y:0,z:0},[r.SPINE]:{x:0,y:0,z:0}}},dragging:{name:"dragging",duration:.2,bones:{[r.LEFT_UPPER_ARM]:{x:0,y:0,z:.8},[r.RIGHT_UPPER_ARM]:{x:0,y:0,z:-.8},[r.LEFT_LOWER_ARM]:{x:-.3,y:0,z:0},[r.RIGHT_LOWER_ARM]:{x:-.3,y:0,z:0},[r.LEFT_UPPER_LEG]:{x:.2,y:0,z:0},[r.RIGHT_UPPER_LEG]:{x:.2,y:0,z:0}}},thinking:{name:"thinking",duration:.5,bones:{[r.RIGHT_UPPER_ARM]:{x:.8,y:0,z:-1.2},[r.RIGHT_LOWER_ARM]:{x:-1.8,y:0,z:0},[r.HEAD]:{x:.1,y:-.1,z:0},[r.LEFT_UPPER_ARM]:{x:.3,y:0,z:.6},[r.LEFT_LOWER_ARM]:{x:-.5,y:0,z:0}}}},At=["waving","stretching","lookingAround"];class he{constructor(){this.vrm=null,this.currentPose="idle",this.targetPose="idle",this.transitionProgress=1,this.transitionDuration=.5,this.transitionTime=0,this.currentBoneRotations={},this.targetBoneRotations={},this.initialBoneRotations={},this.isPlayingGesture=!1,this.gestureTimer=0,this.gestureEndTime=0,this.gestureReturnPose="idle",this.idleGestureTimer=0,this.nextGestureTime=this._randomGestureDelay(),this.enableIdleGestures=!0,this.time=0,this.breathingPhase=0,this.swayPhase=0,this.dancePhase=0,this.danceIntensity=0,this.isSitting=!1,this.sittingTransition=0,this.onPoseChange=null}initialize(t){return!t||!t.humanoid?(console.error("[VRMAnimationService] Invalid VRM or no humanoid"),!1):(this.vrm=t,this._storeInitialRotations(),this.setPose("idle",!0),console.log("[VRMAnimationService] Initialized with VRM"),!0)}_storeInitialRotations(){var t;(t=this.vrm)!=null&&t.humanoid&&Object.values(r).forEach(e=>{const i=this.vrm.humanoid.getNormalizedBoneNode(e);i&&(this.initialBoneRotations[e]={x:i.rotation.x,y:i.rotation.y,z:i.rotation.z},this.currentBoneRotations[e]={...this.initialBoneRotations[e]})})}setPose(t,e=!1){var n;const i=rt[t];if(!i){console.warn(`[VRMAnimationService] Unknown pose: ${t}`);return}if(this.isPlayingGesture&&!e){this.gestureReturnPose=t;return}this.targetPose=t,this.transitionDuration=i.duration,e?(this.transitionProgress=1,this._applyPoseImmediately(i)):(this.transitionProgress=0,this.transitionTime=0,this._calculateTargetRotations(i)),i.isGesture&&(this.isPlayingGesture=!0,this.gestureTimer=0,this.gestureEndTime=i.gestureDuration||2),this.currentPose=t,(n=this.onPoseChange)==null||n.call(this,t)}_calculateTargetRotations(t){this.targetBoneRotations={},Object.values(r).forEach(e=>{var i,n,s;t.bones[e]?this.targetBoneRotations[e]={x:(((i=this.initialBoneRotations[e])==null?void 0:i.x)||0)+t.bones[e].x,y:(((n=this.initialBoneRotations[e])==null?void 0:n.y)||0)+t.bones[e].y,z:(((s=this.initialBoneRotations[e])==null?void 0:s.z)||0)+t.bones[e].z}:this.targetBoneRotations[e]={...this.currentBoneRotations[e]}})}_applyPoseImmediately(t){var e;(e=this.vrm)!=null&&e.humanoid&&Object.entries(t.bones).forEach(([i,n])=>{const s=this.vrm.humanoid.getNormalizedBoneNode(i);if(s){const a=this.initialBoneRotations[i]||{x:0,y:0,z:0};s.rotation.x=a.x+n.x,s.rotation.y=a.y+n.y,s.rotation.z=a.z+n.z,this.currentBoneRotations[i]={x:s.rotation.x,y:s.rotation.y,z:s.rotation.z}}})}triggerRandomGesture(){if(this.isPlayingGesture||!this.enableIdleGestures)return;const t=At[Math.floor(Math.random()*At.length)];this.gestureReturnPose=this.currentPose,this.setPose(t)}update(t){var e,i,n;if((e=this.vrm)!=null&&e.humanoid){if(this.time+=t,this.transitionProgress<1){this.transitionTime+=t,this.transitionProgress=Math.min(1,this.transitionTime/this.transitionDuration);const s=this._easeInOutCubic(this.transitionProgress);this._applyInterpolatedPose(s)}if(this.isPlayingGesture){this.gestureTimer+=t;const s=rt[this.currentPose];((i=s==null?void 0:s.animation)==null?void 0:i.type)==="sequence"&&this._updateAnimatedGesture(s.animation,this.gestureTimer/s.gestureDuration),this.gestureTimer>=this.gestureEndTime&&(this.isPlayingGesture=!1,(n=rt[this.currentPose])!=null&&n.returnToIdle&&this.setPose(this.gestureReturnPose))}!this.isPlayingGesture&&this.currentPose==="idle"&&this.enableIdleGestures&&(this.idleGestureTimer+=t,this.idleGestureTimer>=this.nextGestureTime&&(this.idleGestureTimer=0,this.nextGestureTime=this._randomGestureDelay(),Math.random()<.3&&this.triggerRandomGesture())),this._applyMicroAnimations(t),this.currentPose==="dancing"&&this._applyDanceAnimation(t)}}_applyMicroAnimations(t){var u;if(!((u=this.vrm)!=null&&u.humanoid)||this.isPlayingGesture||this.currentPose==="sleeping"||this.currentPose==="dancing")return;const e=this.time,i=this.vrm.humanoid.getNormalizedBoneNode(r.HEAD);if(i){const o=Math.sin(e*.3)*.008,h=Math.sin(e*.2)*.005;i.rotation.x+=o,i.rotation.y+=h}const n=this.vrm.humanoid.getNormalizedBoneNode(r.CHEST),s=this.vrm.humanoid.getNormalizedBoneNode(r.SPINE);if(n||s){const h=(Math.sin(e*.8)*.5+.5)*.003;n&&n.scale.set(1+h,1+h*.5,1+h)}if(this.currentPose==="idle"){const o=this.vrm.humanoid.getNormalizedBoneNode(r.HIPS);if(o){const h=Math.sin(e*.15)*.003;o.rotation.z+=h}}const a=this.vrm.humanoid.getNormalizedBoneNode(r.LEFT_HAND),c=this.vrm.humanoid.getNormalizedBoneNode(r.RIGHT_HAND);if(a){const o=Math.sin(e*.4+.5)*.01;a.rotation.x+=o}if(c){const o=Math.sin(e*.35)*.01;c.rotation.x+=o}}_applyInterpolatedPose(t){var e;(e=this.vrm)!=null&&e.humanoid&&(Object.values(r).forEach(i=>{const n=this.vrm.humanoid.getNormalizedBoneNode(i);if(!n)return;const s=this.currentBoneRotations[i]||{x:0,y:0,z:0},a=this.targetBoneRotations[i]||s;n.rotation.x=K.lerp(s.x,a.x,t),n.rotation.y=K.lerp(s.y,a.y,t),n.rotation.z=K.lerp(s.z,a.z,t)}),t>=1&&Object.values(r).forEach(i=>{const n=this.vrm.humanoid.getNormalizedBoneNode(i);n&&(this.currentBoneRotations[i]={x:n.rotation.x,y:n.rotation.y,z:n.rotation.z})}))}_updateAnimatedGesture(t,e){var u;if(!((u=this.vrm)!=null&&u.humanoid)||t.type!=="sequence")return;const i=t.keyframes;let n=i[0],s=i[i.length-1];for(let o=0;o<i.length-1;o++)if(e>=i[o].time&&e<i[o+1].time){n=i[o],s=i[o+1];break}const a=(e-n.time)/(s.time-n.time),c=this._easeInOutCubic(Math.max(0,Math.min(1,a)));Object.keys(n.bones||{}).forEach(o=>{var p;const h=this.vrm.humanoid.getNormalizedBoneNode(o);if(!h)return;const d=n.bones[o]||{},g=((p=s.bones)==null?void 0:p[o])||d;if(d.y!==void 0&&g.y!==void 0){const A=this.initialBoneRotations[o]||{y:0};h.rotation.y=A.y+K.lerp(d.y,g.y,c)}})}_applyBreathingAnimation(t){}_applySwayAnimation(t){}_applyDanceAnimation(t){var u;if(!((u=this.vrm)!=null&&u.humanoid))return;this.dancePhase+=t*4;const e=this.danceIntensity||1,i=Math.abs(Math.sin(this.dancePhase))*.1*e,n=Math.sin(this.dancePhase*2)*.3*e,s=this.vrm.humanoid.getNormalizedBoneNode(r.HIPS),a=this.vrm.humanoid.getNormalizedBoneNode(r.LEFT_UPPER_ARM),c=this.vrm.humanoid.getNormalizedBoneNode(r.RIGHT_UPPER_ARM);s&&(s.position.y+=i),a&&(a.rotation.z+=n),c&&(c.rotation.z-=n)}setDanceIntensity(t){this.danceIntensity=Math.max(0,Math.min(1,t))}setSitting(t){this.isSitting!==t&&(this.isSitting=t,t?this.setPose("sitting"):this.setPose("idle"))}setIdleGesturesEnabled(t){this.enableIdleGestures=t}_randomGestureDelay(){return 10+Math.random()*20}_easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}getCurrentPose(){return this.currentPose}isInGesture(){return this.isPlayingGesture}dispose(){this.vrm=null,this.currentBoneRotations={},this.targetBoneRotations={},this.initialBoneRotations={}}}let at=null;function de(){return at||(at=new he),at}const $={IDLE:"idle",PLAYING:"playing",PAUSED:"paused"};class me{constructor(){this.duration=0,this.restHipsPosition=new X,this.humanoidTracks={translation:new Map,rotation:new Map},this.expressionTracks={preset:new Map,custom:new Map},this.lookAtTrack=null}}class fe extends kt{constructor(t){super(),this._lookAt=t,this._quaternion=new Wt}get quaternion(){return this._quaternion}set quaternion(t){if(this._quaternion.copy(t),this._lookAt){const e=new jt().setFromQuaternion(t,"YXZ");this._lookAt.yaw=K.radToDeg(e.y),this._lookAt.pitch=K.radToDeg(e.x)}}}class ge{constructor(){this.vrm=null,this.mixer=null,this.animations=new Map,this.currentAnimation=null,this.state=$.IDLE,this.lookAtProxy=null,this.blendDuration=.3,this.clock=new Lt,this.GLTFLoader=null,this.VRMAnimationLoaderPlugin=null,this.loaderReady=!1,this.animationLibrary={idle:null,sitting:null,dancing:null,waving:null,thinking:null}}initialize(t){var e;return t?(this.vrm=t,this.mixer=new Ft(t.scene),t.lookAt&&(this.lookAtProxy=new fe(t.lookAt),this.lookAtProxy.name="VRMLookAtQuaternionProxy",t.scene.add(this.lookAtProxy)),console.log("[VRMAAnimationService] Initialized with VRM:",(e=t.meta)==null?void 0:e.name),!0):(console.error("[VRMAAnimationService] Cannot initialize without VRM"),!1)}async _ensureLoader(){if(this.loaderReady)return!0;try{const[t]=await Promise.all([dt(()=>import("./GLTFLoader-SeKim6zn.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)]);return this.GLTFLoader=t.GLTFLoader,this.loaderReady=!0,!0}catch(t){return console.error("[VRMAAnimationService] Failed to load dependencies:",t),!1}}async loadAnimation(t,e){return this.vrm?await this._ensureLoader()?new Promise((i,n)=>{const s=new this.GLTFLoader;s.crossOrigin="anonymous",s.register(a=>new pe(a)),s.load(t,a=>{const c=a.userData.vrmAnimations;if(!c||c.length===0){console.warn("[VRMAAnimationService] No VRM animations found in",t),i(!1);return}const u=c[0],o=this._createAnimationClip(u,this.vrm);if(!o){console.error("[VRMAAnimationService] Failed to create animation clip"),i(!1);return}const h=this.mixer.clipAction(o);this.animations.set(e,{vrmAnimation:u,clip:o,action:h,duration:o.duration}),console.log(`[VRMAAnimationService] Loaded animation: ${e} (${o.duration.toFixed(2)}s)`),i(!0)},a=>{console.log(`[VRMAAnimationService] Loading ${e}: ${(a.loaded/a.total*100).toFixed(1)}%`)},a=>{console.error("[VRMAAnimationService] Load error:",a),n(a)})}):!1:(console.error("[VRMAAnimationService] VRM not initialized"),!1)}_createAnimationClip(t,e){var s;const i=[],n=this._createHumanoidTracks(t,e.humanoid,((s=e.meta)==null?void 0:s.metaVersion)||"1");if(i.push(...n.translation.values()),i.push(...n.rotation.values()),e.expressionManager){const a=this._createExpressionTracks(t,e.expressionManager);i.push(...a.preset.values()),i.push(...a.custom.values())}if(e.lookAt&&this.lookAtProxy&&t.lookAtTrack){const a=t.lookAtTrack.clone();a.name=`${this.lookAtProxy.name}.quaternion`,i.push(a)}return i.length===0?(console.warn("[VRMAAnimationService] No tracks created from VRM animation"),null):new Ct("VRMAClip",t.duration,i)}_createHumanoidTracks(t,e,i){var a,c,u;const n=new Map,s=new Map;for(const[o,h]of t.humanoidTracks.rotation.entries()){const d=e.getNormalizedBoneNode(o);if(!d)continue;const g=new Bt(`${d.name}.quaternion`,h.times,h.values.map((p,A)=>i==="0"&&A%2===0?-p:p));s.set(o,g)}for(const[o,h]of t.humanoidTracks.translation.entries()){const d=e.getNormalizedBoneNode(o);if(!d)continue;const g=t.restHipsPosition.y||1,A=(((u=(c=(a=e.normalizedRestPose)==null?void 0:a.hips)==null?void 0:c.position)==null?void 0:u[1])||1)/g,z=h.clone();z.values=z.values.map((k,b)=>(i==="0"&&b%3!==1?-k:k)*A),z.name=`${d.name}.position`,n.set(o,z)}return{translation:n,rotation:s}}_createExpressionTracks(t,e){var s,a;const i=new Map,n=new Map;for(const[c,u]of t.expressionTracks.preset.entries()){const o=(s=e.getExpressionTrackName)==null?void 0:s.call(e,c);if(o){const h=u.clone();h.name=o,i.set(c,h)}}for(const[c,u]of t.expressionTracks.custom.entries()){const o=(a=e.getExpressionTrackName)==null?void 0:a.call(e,c);if(o){const h=u.clone();h.name=o,n.set(c,h)}}return{preset:i,custom:n}}play(t,e={}){const i=this.animations.get(t);if(!i)return console.warn(`[VRMAAnimationService] Animation not found: ${t}`),!1;const{loop:n=Ut,fadeIn:s=this.blendDuration,timeScale:a=1}=e;if(this.currentAnimation&&this.currentAnimation!==t){const u=this.animations.get(this.currentAnimation);u!=null&&u.action&&u.action.fadeOut(s)}const{action:c}=i;return c.reset(),c.setLoop(n,1/0),c.timeScale=a,c.fadeIn(s),c.play(),this.currentAnimation=t,this.state=$.PLAYING,console.log(`[VRMAAnimationService] Playing: ${t}`),!0}stop(t=this.blendDuration){if(this.currentAnimation){const e=this.animations.get(this.currentAnimation);e!=null&&e.action&&e.action.fadeOut(t),this.currentAnimation=null}this.state=$.IDLE}pause(){if(this.currentAnimation){const t=this.animations.get(this.currentAnimation);t!=null&&t.action&&(t.action.paused=!0),this.state=$.PAUSED}}resume(){if(this.currentAnimation&&this.state===$.PAUSED){const t=this.animations.get(this.currentAnimation);t!=null&&t.action&&(t.action.paused=!1),this.state=$.PLAYING}}update(t){this.mixer&&this.mixer.update(t)}getAnimationNames(){return Array.from(this.animations.keys())}hasAnimation(t){return this.animations.has(t)}getState(){return{state:this.state,currentAnimation:this.currentAnimation,animationCount:this.animations.size}}dispose(){var t;this.stop(0),this.mixer&&(this.mixer.stopAllAction(),this.mixer=null),this.lookAtProxy&&((t=this.vrm)!=null&&t.scene)&&this.vrm.scene.remove(this.lookAtProxy),this.animations.clear(),this.vrm=null,this.lookAtProxy=null,console.log("[VRMAAnimationService] Disposed")}}class pe{constructor(t){this.parser=t}get name(){return"VRMC_vrm_animation"}async afterRoot(t){var u;const e=t.parser.json,i=e.extensionsUsed;if(!i||!i.includes(this.name))return;const n=(u=e.extensions)==null?void 0:u[this.name];if(!n)return;const s=this._createNodeMap(n),c=t.animations.map((o,h)=>{const d=e.animations[h];return this._parseAnimation(o,d,s)});t.userData.vrmAnimations=c}_createNodeMap(t){var u,o,h,d;const e=new Map,i=new Map,n=(u=t.humanoid)==null?void 0:u.humanBones;n&&Object.entries(n).forEach(([g,p])=>{const A=p==null?void 0:p.node;A!=null&&e.set(A,g)});const s=(o=t.expressions)==null?void 0:o.preset;s&&Object.entries(s).forEach(([g,p])=>{const A=p==null?void 0:p.node;A!=null&&i.set(A,g)});const a=(h=t.expressions)==null?void 0:h.custom;a&&Object.entries(a).forEach(([g,p])=>{const{node:A}=p;i.set(A,g)});const c=((d=t.lookAt)==null?void 0:d.node)??null;return{humanoidIndexToName:e,expressionsIndexToName:i,lookAtIndex:c}}_parseAnimation(t,e,i){const n=t.tracks,s=e.channels,a=new me;return a.duration=t.duration,s.forEach((c,u)=>{const{node:o,path:h}=c.target,d=n[u];if(o==null)return;const g=i.humanoidIndexToName.get(o);if(g!=null){h==="translation"?g==="hips"&&a.humanoidTracks.translation.set(g,d.clone()):h==="rotation"&&a.humanoidTracks.rotation.set(g,d.clone());return}const p=i.expressionsIndexToName.get(o);if(p!=null){if(h==="translation"){const A=d.times,z=new Float32Array(d.values.length/3);for(let S=0;S<z.length;S++)z[S]=d.values[3*S];const k=new $t(`${p}.weight`,A,z);["happy","angry","sad","relaxed","surprised","aa","ih","ou","ee","oh","blink","blinkLeft","blinkRight","lookUp","lookDown","lookLeft","lookRight","neutral"].includes(p)?a.expressionTracks.preset.set(p,k):a.expressionTracks.custom.set(p,k)}return}o===i.lookAtIndex&&h==="rotation"&&(a.lookAtTrack=d.clone())}),a}}let lt=null;const Re=()=>(lt||(lt=new ge),lt);class ye{constructor(){this.raycaster=new Kt,this.pointer=new _t,this.boneMap={head:"head",neck:"head",chest:"chest",spine:"chest",upperChest:"chest",hips:"chest",leftHand:"hand_l",rightHand:"hand_r",leftLowerArm:"hand_l",rightLowerArm:"hand_r"},this.interactions={head:{expression:"happy",message:["Pat pat!","Hehe!","That feels nice.","You are kind."],mood:"happy"},chest:{expression:"surprised",message:["Hey!","Poke!","Tickles!","What was that?"],mood:"playful"},hand_l:{expression:"happy",message:["High five!","Holding hands?","Hello!","Wave!"],mood:"friendly"},hand_r:{expression:"happy",message:["High five!","Shake hands?","Greetings!","Hello!"],mood:"friendly"}},this.lastTouchTime=0,this.touchCooldown=1e3}handleTouch(t,e){const i=Date.now();if(i-this.lastTouchTime<this.touchCooldown)return;let n=t.object,s=null;if(n.name){const c=n.name.toLowerCase();for(const u of Object.keys(this.boneMap))if(c.includes(u.toLowerCase())){s=u;break}}if(!s&&e.humanoid,!s){const c=t.point,o=e.scene.worldToLocal(c.clone());o.y>1.3?s="head":o.y>.8?s="chest":s="hips"}const a=this.boneMap[s];a&&(this.triggerReaction(a),this.lastTouchTime=i,t.stopPropagation())}triggerReaction(t){const e=this.interactions[t]||this.interactions.head;let i=t;(t==="hand_l"||t==="hand_r")&&(i="hands");const n=Qt.getTouchMessage(i);window.nizhal&&window.nizhal.invoke&&window.nizhal.invoke("persona:updateMood",e.mood).catch(()=>{}),xt.messageCallback&&xt.messageCallback(n)}}const xe=new ye;Yt(Zt);let ct=null,ut=null,ht=null;const Pe=async()=>{if(!ct||!ut){const l=await dt(()=>import("./three-vrm.module-Btd07GQG.js"),__vite__mapDeps([4,1,2,3]),import.meta.url);ct=l.VRMLoaderPlugin,ut=l.VRMUtils}return ht||(ht=(await dt(()=>import("./GLTFLoader-SeKim6zn.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)).GLTFLoader),{VRMLoaderPlugin:ct,VRMUtils:ut,GLTFLoader:ht}},Ae=({url:l,scale:t=1,position:e=[0,0,0],enableLookAt:i=!0,enableBlink:n=!0,expression:s="neutral",isSpeaking:a=!1,onLoad:c,onError:u})=>{const[o,h]=m.useState(null),[d,g]=m.useState(!0),{camera:p,mouse:A,size:z}=Mt();m.useRef(new Lt);const k=m.useRef(0),b=m.useRef(0),S=m.useRef(null),nt=m.useRef(Xt()),O=m.useRef(de()),F=m.useRef(Re());return m.useEffect(()=>{let E=!0;return(async()=>{try{const{VRMLoaderPlugin:w,VRMUtils:x,GLTFLoader:M}=await Pe(),R=new M;R.crossOrigin="anonymous",R.register(P=>new w(P,{autoUpdateHumanBones:!0})),R.load(l,P=>{var N;if(!E)return;const T=P.userData.vrm;if(T){if(x.removeUnnecessaryVertices(P.scene),x.combineSkeletons(P.scene),x.combineMorphs(T),T.scene.traverse(f=>{f.frustumCulled=!1}),T.scene.rotation.y=Math.PI,T.lookAt){const f=new kt;f.position.set(0,1.5,1),T.lookAt.target=f,S.current=f}O.current&&(O.current.initialize(T),console.log("[OptimizedVRMModel] Procedural animation service initialized")),F.current&&(F.current.initialize(T),console.log("[OptimizedVRMModel] VRMA animation service initialized"),F.current.loadAnimation("/animations/test.vrma","test").then(f=>{f&&console.log("[OptimizedVRMModel] Test VRMA animation loaded")}).catch(f=>console.warn("[OptimizedVRMModel] No test.vrma found:",f))),console.log("VRM loaded:",((N=T.meta)==null?void 0:N.name)||l),h(T),c==null||c(T)}else console.error("No VRM data found in model"),u==null||u(new Error("No VRM data found"));g(!1)},P=>{P.total>0&&console.log(`Loading VRM: ${(P.loaded/P.total*100).toFixed(1)}%`)},P=>{console.error("VRM load error:",P),u==null||u(P),g(!1)})}catch(w){console.error("Failed to load VRM deps:",w),g(!1)}})(),()=>{E=!1}},[l]),Et((E,q)=>{var v;if(!o||(b.current++,b.current%2!==0))return;const w=q*2;o.update(w);const x=nt.current;x.update(w);const M=x.getAnimationParams(),R=x.getState(),P=O.current;if(P&&o.humanoid){const I={[_.IDLE]:"idle",[_.DRAGGING]:"dragging",[_.SITTING_WINDOW]:"sitting",[_.SITTING_TASKBAR]:"sitting",[_.DANCING]:"dancing",[_.SLEEPING]:"sleeping",[_.THINKING]:"thinking",[_.SPEAKING]:"idle"}[R]||"idle";P.getCurrentPose()!==I&&!P.isInGesture()&&P.setPose(I),P.update(w)}const T=F.current;if(T&&T.update(w),i&&o.lookAt&&S.current&&R!==_.SLEEPING){const G=A.x*2,I=A.y*1+1.5;S.current.position.set(G,I,1)}if(n&&R!==_.SLEEPING&&(k.current+=w,k.current>3+Math.random()*4&&(k.current=0,(v=o.expressionManager)!=null&&v.getExpression("blink")&&(o.expressionManager.setValue("blink",1),setTimeout(()=>{var I;(I=o.expressionManager)==null||I.setValue("blink",0)},100)))),a&&o.expressionManager){const G=.3+Math.sin(E.clock.elapsedTime*15)*.2;o.expressionManager.setValue("aa",G),R!==_.SPEAKING&&x.setState(_.SPEAKING)}else o.expressionManager&&(o.expressionManager.setValue("aa",0),R===_.SPEAKING&&x.setState(_.IDLE));if(o.expressionManager&&M.expression)try{o.expressionManager.getExpression(M.expression)&&o.expressionManager.setValue(M.expression,M.expressionWeight||.5)}catch{}R===_.SLEEPING&&o.expressionManager&&o.expressionManager.setValue("blink",1);const N=E.clock.elapsedTime;let f=0,Y=0;M.breathingSpeed>0&&(f+=Math.sin(N*M.breathingSpeed)*(M.breathingAmplitude*.3)),R===_.DANCING&&M.bounceSpeed&&(f+=Math.abs(Math.sin(N*M.bounceSpeed))*M.bounceAmplitude,P==null||P.setDanceIntensity(M.expressionWeight||.8)),R===_.DRAGGING&&M.floatSpeed&&(f+=Math.sin(N*M.floatSpeed)*M.floatAmplitude),o.scene&&(o.scene.position.y=f,o.scene.rotation.z=Y)}),d?H.jsx(ue,{center:!0,children:H.jsx("div",{className:"text-white text-sm animate-pulse",children:"Loading..."})}):o?H.jsx("primitive",{object:o.scene,scale:t,position:e,onClick:E=>xe.handleTouch(E,o)}):null},ke=({modelUrl:l,size:t={width:200,height:300},expression:e="neutral",isSpeaking:i=!1,isThinking:n=!1,enableInteraction:s=!0,quality:a="medium",onLoad:c,onError:u})=>{const[o,h]=m.useState(!1),d=m.useMemo(()=>({low:{pixelRatio:.5,antialias:!1,shadows:!1},medium:{pixelRatio:.75,antialias:!0,shadows:!1},high:{pixelRatio:1,antialias:!0,shadows:!0}}),[]),g=d[a]||d.medium,p=m.useCallback(A=>{h(!0),c==null||c(A)},[c]);return H.jsxs("div",{style:{width:t.width,height:t.height},className:"relative",children:[H.jsxs(qt,{camera:{position:[0,.8,3],fov:50},dpr:g.pixelRatio,gl:{antialias:g.antialias,alpha:!0,powerPreference:"default",preserveDrawingBuffer:!0},style:{background:"transparent"},frameloop:"always",children:[H.jsx("ambientLight",{intensity:.6}),H.jsx("directionalLight",{position:[5,5,5],intensity:.5}),H.jsx(Ae,{url:l,scale:1,expression:e,isSpeaking:i,onLoad:p,onError:u},l),s&&H.jsx(te,{enableZoom:!1,enablePan:!1,minPolarAngle:Math.PI/3,maxPolarAngle:Math.PI/2,target:[0,1,0]})]},l),n&&H.jsx("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 text-lg animate-bounce",children:"ðŸ’­"})]})};export{Ae as OptimizedVRMModel,ke as default};

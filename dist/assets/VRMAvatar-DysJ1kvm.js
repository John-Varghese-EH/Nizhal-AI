import{j as i,A as F,m as C}from"./animation-Bl1i2YEf.js";import{a as o}from"./react-vendor-DIqo-C3o.js";import{d as T,A as E,C as P,u as L,V as W,a as N}from"./three-CwDwxXp6.js";import{GLTFLoader as D}from"./GLTFLoader-3dBYMb61.js";import{VRMLoaderPlugin as H,VRMUtils as S}from"./three-vrm.module-BHw-iIqj.js";import{O}from"./OrbitControls-CFX3C8mP.js";class B{constructor(){this.loader=new D,this.loader.register(e=>new H(e)),this.currentVRM=null,this.mixer=null,this.clock=new T,this.expressionMap={happy:["happy","joy","smile"],sad:["sad","sorrow"],angry:["angry"],surprised:["surprised"],neutral:["neutral"],aa:["aa","a"],ih:["ih","i"],ou:["ou","o"],ee:["ee","e"],oh:["oh","u"],blink:["blink","blinkLeft","blinkRight"]}}async loadVRM(e){return new Promise((s,u)=>{this.loader.load(e,n=>{var r;const l=n.userData.vrm;if(!l){u(new Error("No VRM data found in model"));return}S.removeUnnecessaryVertices(n.scene),S.removeUnnecessaryJoints(n.scene),l.scene.rotation.y=Math.PI,this.currentVRM=l,this.mixer=new E(l.scene),console.log("VRM loaded successfully:",{expressionNames:(r=l.expressionManager)!=null&&r.expressionMap?Object.keys(l.expressionManager.expressionMap):[],hasLookAt:!!l.lookAt,hasSpringBone:!!l.springBoneManager}),s({vrm:l,scene:l.scene,mixer:this.mixer,meta:l.meta})},n=>{console.log(`Loading VRM: ${(n.loaded/n.total*100).toFixed(1)}%`)},n=>{console.error("VRM load error:",n),u(n)})})}update(e){this.currentVRM&&this.currentVRM.update(e),this.mixer&&this.mixer.update(e)}setExpression(e,s=1){var l;if(!((l=this.currentVRM)!=null&&l.expressionManager))return;const u=this.currentVRM.expressionManager,n=this.expressionMap[e]||[e];for(const r of n)try{return u.setValue(r,s),!0}catch{continue}return!1}resetExpressions(){var s;if(!((s=this.currentVRM)!=null&&s.expressionManager))return;const e=this.currentVRM.expressionManager;e.resetValues&&e.resetValues()}lookAt(e){var s;(s=this.currentVRM)!=null&&s.lookAt&&(this.currentVRM.lookAt.target=e)}async blink(e=150){this.setExpression("blink",1),await new Promise(s=>setTimeout(s,e)),this.setExpression("blink",0)}getExpressionNames(){var e;return(e=this.currentVRM)!=null&&e.expressionManager?Object.keys(this.currentVRM.expressionManager.expressionMap||{}):[]}dispose(){this.currentVRM&&(S.deepDispose(this.currentVRM.scene),this.currentVRM=null),this.mixer&&(this.mixer.stopAllAction(),this.mixer=null)}}class ${constructor(){this.audioContext=null,this.analyser=null,this.dataArray=null,this.isAnalyzing=!1,this.callbacks=new Set,this.visemeWeights={aa:0,ee:0,ih:0,oh:0,ou:0,closed:1},this.animationFrame=null}async initialize(){if(!this.audioContext)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.analyser.smoothingTimeConstant=.8,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),console.log("LipSync audio context initialized")}catch(e){console.error("Failed to initialize audio context:",e)}}startAnalysis(e){if(!(!this.audioContext||!e))try{this.audioContext.state==="suspended"&&this.audioContext.resume(),this.audioContext.createMediaElementSource(e).connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.isAnalyzing=!0,this.analyze()}catch(s){console.warn("Audio source connection warning:",s.message),this.isAnalyzing=!0,this.analyze()}}async startMicrophoneAnalysis(){this.audioContext||await this.initialize();try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});return this.audioContext.createMediaStreamSource(e).connect(this.analyser),this.isAnalyzing=!0,this.analyze(),e}catch(e){return console.error("Microphone access denied:",e),null}}analyze(){if(!this.isAnalyzing||!this.analyser)return;this.analyser.getByteFrequencyData(this.dataArray);let e=0;for(let r=0;r<this.dataArray.length;r++)e+=this.dataArray[r];const s=e/(this.dataArray.length*255),u=Math.min(1,s*3),n=Date.now()*.01,l=Math.sin(n)*.3+.7;this.visemeWeights={aa:u*l,ee:u*(1-l)*.5,ih:u*Math.abs(Math.sin(n*1.3))*.3,oh:u*Math.abs(Math.cos(n))*.4,ou:u*Math.abs(Math.sin(n*.7))*.3,closed:1-u},this.callbacks.forEach(r=>r(this.visemeWeights,s)),this.animationFrame=requestAnimationFrame(()=>this.analyze())}stopAnalysis(){this.isAnalyzing=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.visemeWeights={aa:0,ee:0,ih:0,oh:0,ou:0,closed:1},this.callbacks.forEach(e=>e(this.visemeWeights,0))}onVisemeUpdate(e){return this.callbacks.add(e),()=>this.callbacks.delete(e)}getVisemes(){return{...this.visemeWeights}}simulateLipSync(e,s){const l=e.split(" ").length*2,r=s/l;let x=0;this.isAnalyzing=!0;const f=()=>{if(!this.isAnalyzing||x>=s){this.stopAnalysis();return}const y=x%r/r,h=Math.sin(y*Math.PI),t=Math.random()*.3;this.visemeWeights={aa:h*(.7+t),ee:h*t,ih:h*t*.5,oh:h*(.3+t),ou:h*t*.5,closed:1-h},this.callbacks.forEach(g=>g(this.visemeWeights,h)),x+=16,this.animationFrame=requestAnimationFrame(f)};f()}dispose(){this.stopAnalysis(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.callbacks.clear()}}const q=({id:a,position:e,size:s=40,color:u="rgba(255, 100, 150, 0.3)",onTouch:n,onPat:l,debug:r=!1})=>{const[x,f]=o.useState(!1),[y,h]=o.useState(0),t=o.useRef([]),g=o.useRef(null),M=o.useCallback(w=>{if(!x)return;const j=Date.now(),c={x:w.clientX,y:w.clientY,time:j};if(t.current.push(c),t.current.length>10&&t.current.shift(),t.current.length>=5){const m=t.current;let V=0;for(let d=2;d<m.length;d++){const k={x:m[d-1].x-m[d-2].x,y:m[d-1].y-m[d-2].y},R={x:m[d].x-m[d-1].x,y:m[d].y-m[d-1].y},v=k.x*R.y-k.y*R.x,z=k.x*R.x+k.y*R.y,p=Math.atan2(v,z);V+=p}const A=Math.min(1,Math.abs(V)/(Math.PI*2));h(A),A>=1&&(l==null||l(),t.current=[],h(0))}clearTimeout(g.current),g.current=setTimeout(()=>{t.current=[],h(0)},500)},[x,l]);return o.useEffect(()=>(x&&window.addEventListener("mousemove",M),()=>{window.removeEventListener("mousemove",M),clearTimeout(g.current)}),[x,M]),i.jsxs(C.div,{className:"absolute cursor-pointer",style:{left:e.x-s/2,top:e.y-s/2,width:s,height:s,borderRadius:"50%",backgroundColor:r?u:"transparent",border:r?"2px dashed rgba(255,255,255,0.5)":"none"},whileHover:{scale:1.1},whileTap:{scale:.95},onClick:()=>n==null?void 0:n(),onMouseEnter:()=>f(!0),onMouseLeave:()=>{f(!1),h(0),t.current=[]},children:[y>0&&i.jsx(C.div,{className:"absolute inset-0 rounded-full border-2 border-pink-400",style:{clipPath:`inset(${(1-y)*100}% 0 0 0)`},initial:{opacity:0},animate:{opacity:1}}),r&&i.jsx("span",{className:"absolute inset-0 flex items-center justify-center text-xs text-white font-bold",children:a})]})},U=({regions:a,onRegionTouch:e,onRegionPat:s,voicePacks:u={},enabled:n=!0,debug:l=!1,containerRef:r})=>{const[x,f]=o.useState(null),y=o.useRef({}),h=o.useRef(new Audio),t=o.useMemo(()=>[{id:"head",position:{x:50,y:15},size:50,color:"rgba(255, 200, 100, 0.3)"},{id:"face",position:{x:50,y:25},size:40,color:"rgba(255, 150, 200, 0.3)"},{id:"leftHand",position:{x:20,y:60},size:30,color:"rgba(100, 200, 255, 0.3)"},{id:"rightHand",position:{x:80,y:60},size:30,color:"rgba(100, 200, 255, 0.3)"},{id:"body",position:{x:50,y:50},size:60,color:"rgba(200, 100, 255, 0.3)"}],[]),g=a||t,M=o.useCallback((c,m=!1)=>{const V=m?`${c}_pat`:c,A=u[V]||u[c]||[];if(A.length===0)return;const d=Date.now();if(y.current[c]&&d-y.current[c]<1e3)return;y.current[c]=d;const k=A[Math.floor(Math.random()*A.length)];h.current.src=k,h.current.play().catch(R=>console.warn("Audio play failed:",R)),f({regionId:c,isPat:m,timestamp:d}),setTimeout(()=>f(null),2e3)},[u]),w=o.useCallback(c=>{e==null||e(c),M(c,!1)},[e,M]),j=o.useCallback(c=>{s==null||s(c),M(c,!0)},[s,M]);return n?i.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[g.map(c=>{var m,V;return i.jsx(q,{id:c.id,position:{x:c.position.x/100*(((m=r==null?void 0:r.current)==null?void 0:m.offsetWidth)||200),y:c.position.y/100*(((V=r==null?void 0:r.current)==null?void 0:V.offsetHeight)||300)},size:c.size,color:c.color,onTouch:()=>w(c.id),onPat:()=>j(c.id),debug:l},c.id)}),i.jsx(F,{children:x&&i.jsx(C.div,{className:"absolute top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-white/90 rounded-full shadow-lg",initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-20,scale:.8},children:i.jsx("span",{className:"text-sm font-medium text-gray-800",children:x.isPat?"❤️ *happy*":"✨ *touched*"})})})]}):null},G=({vrm:a,lipSyncService:e,mousePosition:s,state:u="idle",enableLookAt:n=!0})=>{const{camera:l}=L(),r=o.useRef(),x=o.useRef(0),f=o.useRef(new W(0,1.5,2));return N((y,h)=>{if(a){if(a.update(h),n&&a.lookAt&&s){const t=(s.x-.5)*4,g=(.5-s.y)*3+1.5;f.current.set(t,g,2),a.lookAt.target=f.current}if(x.current+=h,x.current>3+Math.random()*2&&(x.current=0,a.expressionManager&&(a.expressionManager.setValue("blink",1),setTimeout(()=>{var t;(t=a.expressionManager)==null||t.setValue("blink",0)},150))),e&&a.expressionManager){const t=e.getVisemes();a.expressionManager.setValue("aa",t.aa||0),a.expressionManager.setValue("oh",t.oh||0),a.expressionManager.setValue("ee",t.ee||0)}if(a.expressionManager)switch(u){case"happy":a.expressionManager.setValue("happy",.7);break;case"thinking":a.expressionManager.setValue("neutral",1);break;case"speaking":break;default:a.expressionManager.setValue("neutral",.3)}}}),a?i.jsx("group",{ref:r,children:i.jsx("primitive",{object:a.scene})}):null},X=()=>{const a=o.useRef();return N(e=>{a.current&&(a.current.rotation.y+=.02,a.current.rotation.x=Math.sin(e.clock.elapsedTime)*.3)}),i.jsxs("mesh",{ref:a,children:[i.jsx("octahedronGeometry",{args:[.5,0]}),i.jsx("meshStandardMaterial",{color:"#6366f1",wireframe:!0})]})},Q=({modelUrl:a,state:e="idle",mood:s="neutral",onLoad:u,onError:n,enableTouchRegions:l=!0,enableLipSync:r=!0,voicePacks:x={},size:f="medium",className:y=""})=>{const h=o.useRef(null),[t,g]=o.useState(null),[M,w]=o.useState(!0),[j,c]=o.useState(null),[m,V]=o.useState({x:.5,y:.5}),A=o.useRef(new B),d=o.useRef(r?new $:null),k={small:"w-40 h-56",medium:"w-64 h-80",large:"w-96 h-120",fullscreen:"w-full h-full"};o.useEffect(()=>{if(!a){w(!1);return}return w(!0),c(null),A.current.loadVRM(a).then(({vrm:p})=>{g(p),w(!1),u==null||u(p)}).catch(p=>{console.error("VRM load error:",p),c(p.message),w(!1),n==null||n(p)}),()=>{A.current.dispose()}},[a,u,n]),o.useEffect(()=>(r&&d.current&&d.current.initialize(),()=>{var p;(p=d.current)==null||p.dispose()}),[r]);const R=o.useCallback(p=>{if(!h.current)return;const b=h.current.getBoundingClientRect();V({x:(p.clientX-b.left)/b.width,y:(p.clientY-b.top)/b.height})},[]),v=o.useCallback(p=>{console.log("Touch region:",p),t!=null&&t.expressionManager&&(t.expressionManager.setValue("surprised",.5),setTimeout(()=>{var b;(b=t.expressionManager)==null||b.setValue("surprised",0)},500))},[t]),z=o.useCallback(p=>{console.log("Pat region:",p),t!=null&&t.expressionManager&&(t.expressionManager.setValue("happy",1),setTimeout(()=>{var b;(b=t.expressionManager)==null||b.setValue("happy",0)},2e3))},[t]);return i.jsxs("div",{ref:h,className:`relative ${k[f]} ${y}`,onMouseMove:R,children:[i.jsx(C.div,{className:"absolute inset-0 rounded-2xl bg-gradient-to-b from-purple-500/10 to-blue-500/10 blur-xl",animate:{opacity:[.3,.5,.3]},transition:{duration:3,repeat:1/0}}),i.jsxs(P,{camera:{position:[0,1.2,2.5],fov:35},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.6}),i.jsx("directionalLight",{position:[2,3,2],intensity:.8}),i.jsx("directionalLight",{position:[-2,1,-2],intensity:.3}),i.jsx(o.Suspense,{fallback:i.jsx(X,{}),children:t&&i.jsx(G,{vrm:t,lipSyncService:d.current,mousePosition:m,state:e})}),i.jsx(O,{enablePan:!1,enableZoom:!1,minPolarAngle:Math.PI/3,maxPolarAngle:Math.PI/2,target:[0,1,0]})]}),l&&t&&i.jsx(U,{onRegionTouch:v,onRegionPat:z,voicePacks:x,containerRef:h,debug:!1}),M&&i.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-2xl",children:i.jsx(C.div,{className:"w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full",animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"}})}),j&&i.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-red-500/10 rounded-2xl",children:i.jsxs("div",{className:"text-center p-4",children:[i.jsx("span",{className:"text-red-400 text-sm",children:"Failed to load model"}),i.jsx("p",{className:"text-xs text-gray-400 mt-1",children:j})]})}),e!=="idle"&&i.jsx(C.div,{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 px-3 py-1 rounded-full text-xs font-medium bg-white/10 text-white/80 capitalize",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e})]})};export{Q as default};

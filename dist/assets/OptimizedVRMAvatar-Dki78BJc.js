const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./three-vrm.module-BHw-iIqj.js","./three-CwDwxXp6.js","./react-vendor-DIqo-C3o.js","./animation-Bl1i2YEf.js","./GLTFLoader-3dBYMb61.js"])))=>i.map(i=>d[i]);
import{c as je,_ as ae}from"./globals-_YYcdJxc.js";import{j as b}from"./animation-Bl1i2YEf.js";import{a as t}from"./react-vendor-DIqo-C3o.js";import{u as ce,a as ue,V as Z,D as Se,e as Ve,P as de,O as fe,C as Ee,d as Ce}from"./three-CwDwxXp6.js";import{_ as Te,O as Oe}from"./OrbitControls-CFX3C8mP.js";const D=new Z,Y=new Z,We=new Z,le=new Ve;function ke(e,s,r){const o=D.setFromMatrixPosition(e.matrixWorld);o.project(s);const i=r.width/2,l=r.height/2;return[o.x*i+i,-(o.y*l)+l]}function Le(e,s){const r=D.setFromMatrixPosition(e.matrixWorld),o=Y.setFromMatrixPosition(s.matrixWorld),i=r.sub(o),l=s.getWorldDirection(We);return i.angleTo(l)>Math.PI/2}function Fe(e,s,r,o){const i=D.setFromMatrixPosition(e.matrixWorld),l=i.clone();l.project(s),le.set(l.x,l.y),r.setFromCamera(le,s);const p=r.intersectObjects(o,!0);if(p.length){const f=p[0].distance;return i.distanceTo(r.ray.origin)<f}return!0}function Ae(e,s){if(s instanceof fe)return s.zoom;if(s instanceof de){const r=D.setFromMatrixPosition(e.matrixWorld),o=Y.setFromMatrixPosition(s.matrixWorld),i=s.fov*Math.PI/180,l=r.distanceTo(o);return 1/(2*Math.tan(i/2)*l)}else return 1}function _e(e,s,r){if(s instanceof de||s instanceof fe){const o=D.setFromMatrixPosition(e.matrixWorld),i=Y.setFromMatrixPosition(s.matrixWorld),l=o.distanceTo(i),p=(r[1]-r[0])/(s.far-s.near),f=r[1]-p*s.far;return Math.round(p*l+f)}}const X=e=>Math.abs(e)<1e-10?0:e;function me(e,s,r=""){let o="matrix3d(";for(let i=0;i!==16;i++)o+=X(s[i]*e.elements[i])+(i!==15?",":")");return r+o}const $e=(e=>s=>me(s,e))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),De=(e=>(s,r)=>me(s,e(r),"translate(-50%,-50%)"))(e=>[1/e,1/e,1/e,1,-1/e,-1/e,-1/e,-1,1/e,1/e,1/e,1,1,1,1,1]);function He(e){return e&&typeof e=="object"&&"current"in e}const ze=t.forwardRef(({children:e,eps:s=.001,style:r,className:o,prepend:i,center:l,fullscreen:p,portal:f,distanceFactor:y,sprite:d=!1,transform:m=!1,occlude:a,onOcclude:w,castShadow:H,receiveShadow:k,material:ee,geometry:L,zIndexRange:S=[16777271,0],calculatePosition:V=ke,as:z="div",wrapperClass:P,pointerEvents:E="auto",...c},h)=>{const{gl:C,camera:u,scene:te,size:g,raycaster:he,events:xe,viewport:pe}=ce(),[x]=t.useState(()=>document.createElement(z)),q=t.useRef(null),M=t.useRef(null),se=t.useRef(0),I=t.useRef([0,0]),_=t.useRef(null),U=t.useRef(null),F=(f==null?void 0:f.current)||xe.connected||C.domElement.parentNode,j=t.useRef(null),N=t.useRef(!1),B=t.useMemo(()=>a&&a!=="blending"||Array.isArray(a)&&a.length&&He(a[0]),[a]);t.useLayoutEffect(()=>{const v=C.domElement;a&&a==="blending"?(v.style.zIndex=`${Math.floor(S[0]/2)}`,v.style.position="absolute",v.style.pointerEvents="none"):(v.style.zIndex=null,v.style.position=null,v.style.pointerEvents=null)},[a]),t.useLayoutEffect(()=>{if(M.current){const v=q.current=je.createRoot(x);if(te.updateMatrixWorld(),m)x.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const n=V(M.current,u,g);x.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${n[0]}px,${n[1]}px,0);transform-origin:0 0;`}return F&&(i?F.prepend(x):F.appendChild(x)),()=>{F&&F.removeChild(x),v.unmount()}}},[F,m]),t.useLayoutEffect(()=>{P&&(x.className=P)},[P]);const re=t.useMemo(()=>m?{position:"absolute",top:0,left:0,width:g.width,height:g.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:l?"translate3d(-50%,-50%,0)":"none",...p&&{top:-g.height/2,left:-g.width/2,width:g.width,height:g.height},...r},[r,l,p,g,m]),ge=t.useMemo(()=>({position:"absolute",pointerEvents:E}),[E]);t.useLayoutEffect(()=>{if(N.current=!1,m){var v;(v=q.current)==null||v.render(t.createElement("div",{ref:_,style:re},t.createElement("div",{ref:U,style:ge},t.createElement("div",{ref:h,className:o,style:r,children:e}))))}else{var n;(n=q.current)==null||n.render(t.createElement("div",{ref:h,style:re,className:o,children:e}))}});const A=t.useRef(!0);ue(v=>{if(M.current){u.updateMatrixWorld(),M.current.updateWorldMatrix(!0,!1);const n=m?I.current:V(M.current,u,g);if(m||Math.abs(se.current-u.zoom)>s||Math.abs(I.current[0]-n[0])>s||Math.abs(I.current[1]-n[1])>s){const T=Le(M.current,u);let R=!1;B&&(Array.isArray(a)?R=a.map(O=>O.current):a!=="blending"&&(R=[te]));const $=A.current;if(R){const O=Fe(M.current,u,he,R);A.current=O&&!T}else A.current=!T;$!==A.current&&(w?w(!A.current):x.style.display=A.current?"block":"none");const G=Math.floor(S[0]/2),ve=a?B?[S[0],G]:[G-1,0]:S;if(x.style.zIndex=`${_e(M.current,u,ve)}`,m){const[O,ie]=[g.width/2,g.height/2],J=u.projectionMatrix.elements[5]*ie,{isOrthographicCamera:oe,top:Me,left:ye,bottom:Pe,right:be}=u,we=$e(u.matrixWorldInverse),Re=oe?`scale(${J})translate(${X(-(be+ye)/2)}px,${X((Me+Pe)/2)}px)`:`translateZ(${J}px)`;let W=M.current.matrixWorld;d&&(W=u.matrixWorldInverse.clone().transpose().copyPosition(W).scale(M.current.scale),W.elements[3]=W.elements[7]=W.elements[11]=0,W.elements[15]=1),x.style.width=g.width+"px",x.style.height=g.height+"px",x.style.perspective=oe?"":`${J}px`,_.current&&U.current&&(_.current.style.transform=`${Re}${we}translate(${O}px,${ie}px)`,U.current.style.transform=De(W,1/((y||10)/400)))}else{const O=y===void 0?1:Ae(M.current,u)*y;x.style.transform=`translate3d(${n[0]}px,${n[1]}px,0) scale(${O})`}I.current=n,se.current=u.zoom}}if(!B&&j.current&&!N.current)if(m){if(_.current){const n=_.current.children[0];if(n!=null&&n.clientWidth&&n!=null&&n.clientHeight){const{isOrthographicCamera:T}=u;if(T||L)c.scale&&(Array.isArray(c.scale)?c.scale instanceof Z?j.current.scale.copy(c.scale.clone().divideScalar(1)):j.current.scale.set(1/c.scale[0],1/c.scale[1],1/c.scale[2]):j.current.scale.setScalar(1/c.scale));else{const R=(y||10)/400,$=n.clientWidth*R,G=n.clientHeight*R;j.current.scale.set($,G,1)}N.current=!0}}}else{const n=x.children[0];if(n!=null&&n.clientWidth&&n!=null&&n.clientHeight){const T=1/pe.factor,R=n.clientWidth*T,$=n.clientHeight*T;j.current.scale.set(R,$,1),N.current=!0}j.current.lookAt(v.camera.position)}});const ne=t.useMemo(()=>({vertexShader:m?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[m]);return t.createElement("group",Te({},c,{ref:M}),a&&!B&&t.createElement("mesh",{castShadow:H,receiveShadow:k,ref:j},L||t.createElement("planeGeometry",null),ee||t.createElement("shaderMaterial",{side:Se,vertexShader:ne.vertexShader,fragmentShader:ne.fragmentShader})))});let K=null,Q=null;const Ie=async()=>(K||(K=(await ae(()=>import("./three-vrm.module-BHw-iIqj.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)).VRMLoaderPlugin),Q||(Q=(await ae(()=>import("./GLTFLoader-3dBYMb61.js"),__vite__mapDeps([4,1,2,3]),import.meta.url)).GLTFLoader),{VRMLoaderPlugin:K,GLTFLoader:Q}),Ne=({url:e,scale:s=1,position:r=[0,-1,0],enableLookAt:o=!0,enableBlink:i=!0,expression:l="neutral",isSpeaking:p=!1,onLoad:f,onError:y})=>{const[d,m]=t.useState(null),[a,w]=t.useState(!0),{camera:H,mouse:k,size:ee}=ce();t.useRef(new Ce);const L=t.useRef(0),S=t.useRef(0);return t.useEffect(()=>{let V=!0;return(async()=>{try{const{VRMLoaderPlugin:P,GLTFLoader:E}=await Ie(),c=new E;c.register(h=>new P(h,{autoUpdateHumanBones:!0})),c.load(e,h=>{if(!V)return;const C=h.userData.vrm;C&&(C.scene.traverse(u=>{u.isMesh&&(u.frustumCulled=!0)}),m(C),f==null||f(C)),w(!1)},void 0,h=>{console.error("VRM load error:",h),y==null||y(h),w(!1)})}catch(P){console.error("Failed to load VRM deps:",P),w(!1)}})(),()=>{V=!1}},[e]),ue((V,z)=>{var E;if(!d||(S.current++,S.current%2!==0))return;const P=z*2;if(d.update(P),o&&d.lookAt){const c=k.x*.5,h=k.y*.3;d.lookAt.target.set(c,h+1.5,1)}if(i&&(L.current+=P,L.current>3+Math.random()*4&&(L.current=0,(E=d.expressionManager)!=null&&E.getExpression("blink")&&(d.expressionManager.setValue("blink",1),setTimeout(()=>{var h;(h=d.expressionManager)==null||h.setValue("blink",0)},100)))),p&&d.expressionManager){const c=.3+Math.sin(V.clock.elapsedTime*15)*.2;d.expressionManager.setValue("aa",c)}else d.expressionManager&&d.expressionManager.setValue("aa",0)}),a?b.jsx(ze,{center:!0,children:b.jsx("div",{className:"text-white text-sm animate-pulse",children:"Loading..."})}):d?b.jsx("primitive",{object:d.scene,scale:s,position:r}):null},Je=({modelUrl:e,size:s={width:200,height:300},expression:r="neutral",isSpeaking:o=!1,isThinking:i=!1,enableInteraction:l=!0,quality:p="medium",onLoad:f,onError:y})=>{const[d,m]=t.useState(!1),a=t.useMemo(()=>({low:{pixelRatio:.5,antialias:!1,shadows:!1},medium:{pixelRatio:.75,antialias:!0,shadows:!1},high:{pixelRatio:1,antialias:!0,shadows:!0}}),[]),w=a[p]||a.medium,H=t.useCallback(k=>{m(!0),f==null||f(k)},[f]);return b.jsxs("div",{style:{width:s.width,height:s.height},className:"relative",children:[b.jsxs(Ee,{camera:{position:[0,1.2,2],fov:30},dpr:w.pixelRatio,gl:{antialias:w.antialias,alpha:!0,powerPreference:"default",preserveDrawingBuffer:!0},style:{background:"transparent"},frameloop:"always",children:[b.jsx("ambientLight",{intensity:.6}),b.jsx("directionalLight",{position:[5,5,5],intensity:.5}),b.jsx(Ne,{url:e,scale:1,expression:r,isSpeaking:o,onLoad:H,onError:y}),l&&b.jsx(Oe,{enableZoom:!1,enablePan:!1,minPolarAngle:Math.PI/3,maxPolarAngle:Math.PI/2,target:[0,1,0]})]}),i&&b.jsx("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 text-lg animate-bounce",children:"ðŸ’­"})]})};export{Je as default};

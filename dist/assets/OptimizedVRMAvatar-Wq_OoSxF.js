const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./GLTFLoader-QrdB9JU-.js","./three-dWqUxecu.js","./react-vendor-BoJ_KTUm.js","./animation-MOF9A5il.js","./three-vrm.module-Bgvs_-Yu.js"])))=>i.map(i=>d[i]);
var _t=Object.defineProperty;var Rt=(c,t,n)=>t in c?_t(c,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):c[t]=n;var ct=(c,t,n)=>Rt(c,typeof t!="symbol"?t+"":t,n);import{d as It,_ as Ve}from"./globals-CXJ3sImS.js";import{j as Q}from"./animation-MOF9A5il.js";import{a as f}from"./react-vendor-BoJ_KTUm.js";import{u as oe,a as ot,V as k,D as kt,d as Z,P as Re,O as Ie,M as Ae,f as be,g as ht,Q as tt,h as St,i as Lt,j as yt,A as At,k as bt,l as Mt,L as me,m as je,n as Nt,E as Ot,o as ut,N as Ct,p as Dt,q as zt,C as jt,e as Vt,T as Ht}from"./three-dWqUxecu.js";import{r as Ft,c as dt,g as Gt,A as G}from"./character-DG-dJARq.js";function He(){return He=Object.assign?Object.assign.bind():function(c){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var e in n)({}).hasOwnProperty.call(n,e)&&(c[e]=n[e])}return c},He.apply(null,arguments)}const Se=new k,at=new k,Wt=new k,mt=new Z;function Ut(c,t,n){const e=Se.setFromMatrixPosition(c.matrixWorld);e.project(t);const o=n.width/2,s=n.height/2;return[e.x*o+o,-(e.y*s)+s]}function Yt(c,t){const n=Se.setFromMatrixPosition(c.matrixWorld),e=at.setFromMatrixPosition(t.matrixWorld),o=n.sub(e),s=t.getWorldDirection(Wt);return o.angleTo(s)>Math.PI/2}function $t(c,t,n,e){const o=Se.setFromMatrixPosition(c.matrixWorld),s=o.clone();s.project(t),mt.set(s.x,s.y),n.setFromCamera(mt,t);const r=n.intersectObjects(e,!0);if(r.length){const a=r[0].distance;return o.distanceTo(n.ray.origin)<a}return!0}function Bt(c,t){if(t instanceof Ie)return t.zoom;if(t instanceof Re){const n=Se.setFromMatrixPosition(c.matrixWorld),e=at.setFromMatrixPosition(t.matrixWorld),o=t.fov*Math.PI/180,s=n.distanceTo(e);return 1/(2*Math.tan(o/2)*s)}else return 1}function Kt(c,t,n){if(t instanceof Re||t instanceof Ie){const e=Se.setFromMatrixPosition(c.matrixWorld),o=at.setFromMatrixPosition(t.matrixWorld),s=e.distanceTo(o),r=(n[1]-n[0])/(t.far-t.near),a=n[1]-r*t.far;return Math.round(r*s+a)}}const nt=c=>Math.abs(c)<1e-10?0:c;function wt(c,t,n=""){let e="matrix3d(";for(let o=0;o!==16;o++)e+=nt(t[o]*c.elements[o])+(o!==15?",":")");return n+e}const Zt=(c=>t=>wt(t,c))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),Xt=(c=>(t,n)=>wt(t,c(n),"translate(-50%,-50%)"))(c=>[1/c,1/c,1/c,1,-1/c,-1/c,-1/c,-1,1/c,1/c,1/c,1,1,1,1,1]);function qt(c){return c&&typeof c=="object"&&"current"in c}const Qt=f.forwardRef(({children:c,eps:t=.001,style:n,className:e,prepend:o,center:s,fullscreen:r,portal:a,distanceFactor:l,sprite:h=!1,transform:d=!1,occlude:m,onOcclude:y,castShadow:M,receiveShadow:w,material:L,geometry:R,zIndexRange:H=[16777271,0],calculatePosition:F=Ut,as:U="div",wrapperClass:V,pointerEvents:E="auto",...A},K)=>{const{gl:Y,camera:v,scene:b,size:O,raycaster:we,events:q,viewport:fe}=oe(),[P]=f.useState(()=>document.createElement(U)),D=f.useRef(null),T=f.useRef(null),N=f.useRef(0),_=f.useRef([0,0]),z=f.useRef(null),S=f.useRef(null),C=(a==null?void 0:a.current)||q.connected||Y.domElement.parentNode,j=f.useRef(null),$=f.useRef(!1),J=f.useMemo(()=>m&&m!=="blending"||Array.isArray(m)&&m.length&&qt(m[0]),[m]);f.useLayoutEffect(()=>{const B=Y.domElement;m&&m==="blending"?(B.style.zIndex=`${Math.floor(H[0]/2)}`,B.style.position="absolute",B.style.pointerEvents="none"):(B.style.zIndex=null,B.style.position=null,B.style.pointerEvents=null)},[m]),f.useLayoutEffect(()=>{if(T.current){const B=D.current=It.createRoot(P);if(b.updateMatrixWorld(),d)P.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const I=F(T.current,v,O);P.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${I[0]}px,${I[1]}px,0);transform-origin:0 0;`}return C&&(o?C.prepend(P):C.appendChild(P)),()=>{C&&C.removeChild(P),B.unmount()}}},[C,d]),f.useLayoutEffect(()=>{V&&(P.className=V)},[V]);const ve=f.useMemo(()=>d?{position:"absolute",top:0,left:0,width:O.width,height:O.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:s?"translate3d(-50%,-50%,0)":"none",...r&&{top:-O.height/2,left:-O.width/2,width:O.width,height:O.height},...n},[n,s,r,O,d]),Fe=f.useMemo(()=>({position:"absolute",pointerEvents:E}),[E]);f.useLayoutEffect(()=>{if($.current=!1,d){var B;(B=D.current)==null||B.render(f.createElement("div",{ref:z,style:ve},f.createElement("div",{ref:S,style:Fe},f.createElement("div",{ref:K,className:e,style:n,children:c}))))}else{var I;(I=D.current)==null||I.render(f.createElement("div",{ref:K,style:ve,className:e,children:c}))}});const he=f.useRef(!0);ot(B=>{if(T.current){v.updateMatrixWorld(),T.current.updateWorldMatrix(!0,!1);const I=d?_.current:F(T.current,v,O);if(d||Math.abs(N.current-v.zoom)>t||Math.abs(_.current[0]-I[0])>t||Math.abs(_.current[1]-I[1])>t){const ee=Yt(T.current,v);let X=!1;J&&(Array.isArray(m)?X=m.map(te=>te.current):m!=="blending"&&(X=[b]));const ue=he.current;if(X){const te=$t(T.current,v,we,X);he.current=te&&!ee}else he.current=!ee;ue!==he.current&&(y?y(!he.current):P.style.display=he.current?"block":"none");const ge=Math.floor(H[0]/2),Ge=m?J?[H[0],ge]:[ge-1,0]:H;if(P.style.zIndex=`${Kt(T.current,v,Ge)}`,d){const[te,Pe]=[O.width/2,O.height/2],ye=v.projectionMatrix.elements[5]*Pe,{isOrthographicCamera:Ne,top:We,left:Oe,bottom:xe,right:pe}=v,Ue=Zt(v.matrixWorldInverse),Ye=Ne?`scale(${ye})translate(${nt(-(pe+Oe)/2)}px,${nt((We+xe)/2)}px)`:`translateZ(${ye}px)`;let ne=T.current.matrixWorld;h&&(ne=v.matrixWorldInverse.clone().transpose().copyPosition(ne).scale(T.current.scale),ne.elements[3]=ne.elements[7]=ne.elements[11]=0,ne.elements[15]=1),P.style.width=O.width+"px",P.style.height=O.height+"px",P.style.perspective=Ne?"":`${ye}px`,z.current&&S.current&&(z.current.style.transform=`${Ye}${Ue}translate(${te}px,${Pe}px)`,S.current.style.transform=Xt(ne,1/((l||10)/400)))}else{const te=l===void 0?1:Bt(T.current,v)*l;P.style.transform=`translate3d(${I[0]}px,${I[1]}px,0) scale(${te})`}_.current=I,N.current=v.zoom}}if(!J&&j.current&&!$.current)if(d){if(z.current){const I=z.current.children[0];if(I!=null&&I.clientWidth&&I!=null&&I.clientHeight){const{isOrthographicCamera:ee}=v;if(ee||R)A.scale&&(Array.isArray(A.scale)?A.scale instanceof k?j.current.scale.copy(A.scale.clone().divideScalar(1)):j.current.scale.set(1/A.scale[0],1/A.scale[1],1/A.scale[2]):j.current.scale.setScalar(1/A.scale));else{const X=(l||10)/400,ue=I.clientWidth*X,ge=I.clientHeight*X;j.current.scale.set(ue,ge,1)}$.current=!0}}}else{const I=P.children[0];if(I!=null&&I.clientWidth&&I!=null&&I.clientHeight){const ee=1/fe.factor,X=I.clientWidth*ee,ue=I.clientHeight*ee;j.current.scale.set(X,ue,1),$.current=!0}j.current.lookAt(B.camera.position)}});const Le=f.useMemo(()=>({vertexShader:d?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[d]);return f.createElement("group",He({},A,{ref:T}),m&&!J&&f.createElement("mesh",{castShadow:M,receiveShadow:w,ref:j},R||f.createElement("planeGeometry",null),L||f.createElement("shaderMaterial",{side:kt,vertexShader:Le.vertexShader,fragmentShader:Le.fragmentShader})))});var Jt=Object.defineProperty,en=(c,t,n)=>t in c?Jt(c,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):c[t]=n,tn=(c,t,n)=>(en(c,t+"",n),n);class nn{constructor(){tn(this,"_listeners")}addEventListener(t,n){this._listeners===void 0&&(this._listeners={});const e=this._listeners;e[t]===void 0&&(e[t]=[]),e[t].indexOf(n)===-1&&e[t].push(n)}hasEventListener(t,n){if(this._listeners===void 0)return!1;const e=this._listeners;return e[t]!==void 0&&e[t].indexOf(n)!==-1}removeEventListener(t,n){if(this._listeners===void 0)return;const o=this._listeners[t];if(o!==void 0){const s=o.indexOf(n);s!==-1&&o.splice(s,1)}}dispatchEvent(t){if(this._listeners===void 0)return;const e=this._listeners[t.type];if(e!==void 0){t.target=this;const o=e.slice(0);for(let s=0,r=o.length;s<r;s++)o[s].call(this,t);t.target=null}}}var on=Object.defineProperty,an=(c,t,n)=>t in c?on(c,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):c[t]=n,p=(c,t,n)=>(an(c,typeof t!="symbol"?t+"":t,n),n);const De=new St,ft=new Lt,sn=Math.cos(70*(Math.PI/180)),pt=(c,t)=>(c%t+t)%t;let rn=class extends nn{constructor(t,n){super(),p(this,"object"),p(this,"domElement"),p(this,"enabled",!0),p(this,"target",new k),p(this,"minDistance",0),p(this,"maxDistance",1/0),p(this,"minZoom",0),p(this,"maxZoom",1/0),p(this,"minPolarAngle",0),p(this,"maxPolarAngle",Math.PI),p(this,"minAzimuthAngle",-1/0),p(this,"maxAzimuthAngle",1/0),p(this,"enableDamping",!1),p(this,"dampingFactor",.05),p(this,"enableZoom",!0),p(this,"zoomSpeed",1),p(this,"enableRotate",!0),p(this,"rotateSpeed",1),p(this,"enablePan",!0),p(this,"panSpeed",1),p(this,"screenSpacePanning",!0),p(this,"keyPanSpeed",7),p(this,"zoomToCursor",!1),p(this,"autoRotate",!1),p(this,"autoRotateSpeed",2),p(this,"reverseOrbit",!1),p(this,"reverseHorizontalOrbit",!1),p(this,"reverseVerticalOrbit",!1),p(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),p(this,"mouseButtons",{LEFT:Ae.ROTATE,MIDDLE:Ae.DOLLY,RIGHT:Ae.PAN}),p(this,"touches",{ONE:be.ROTATE,TWO:be.DOLLY_PAN}),p(this,"target0"),p(this,"position0"),p(this,"zoom0"),p(this,"_domElementKeyEvents",null),p(this,"getPolarAngle"),p(this,"getAzimuthalAngle"),p(this,"setPolarAngle"),p(this,"setAzimuthalAngle"),p(this,"getDistance"),p(this,"getZoomScale"),p(this,"listenToKeyEvents"),p(this,"stopListenToKeyEvents"),p(this,"saveState"),p(this,"reset"),p(this,"update"),p(this,"connect"),p(this,"dispose"),p(this,"dollyIn"),p(this,"dollyOut"),p(this,"getScale"),p(this,"setScale"),this.object=t,this.domElement=n,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>d.phi,this.getAzimuthalAngle=()=>d.theta,this.setPolarAngle=i=>{let u=pt(i,2*Math.PI),g=d.phi;g<0&&(g+=2*Math.PI),u<0&&(u+=2*Math.PI);let x=Math.abs(u-g);2*Math.PI-x<x&&(u<g?u+=2*Math.PI:g+=2*Math.PI),m.phi=u-g,e.update()},this.setAzimuthalAngle=i=>{let u=pt(i,2*Math.PI),g=d.theta;g<0&&(g+=2*Math.PI),u<0&&(u+=2*Math.PI);let x=Math.abs(u-g);2*Math.PI-x<x&&(u<g?u+=2*Math.PI:g+=2*Math.PI),m.theta=u-g,e.update()},this.getDistance=()=>e.object.position.distanceTo(e.target),this.listenToKeyEvents=i=>{i.addEventListener("keydown",$e),this._domElementKeyEvents=i},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",$e),this._domElementKeyEvents=null},this.saveState=()=>{e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=()=>{e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(o),e.update(),l=a.NONE},this.update=(()=>{const i=new k,u=new k(0,1,0),g=new tt().setFromUnitVectors(t.up,u),x=g.clone().invert(),W=new k,ae=new tt,de=2*Math.PI;return function(){const lt=e.object.position;g.setFromUnitVectors(t.up,u),x.copy(g).invert(),i.copy(lt).sub(e.target),i.applyQuaternion(g),d.setFromVector3(i),e.autoRotate&&l===a.NONE&&fe(we()),e.enableDamping?(d.theta+=m.theta*e.dampingFactor,d.phi+=m.phi*e.dampingFactor):(d.theta+=m.theta,d.phi+=m.phi);let se=e.minAzimuthAngle,re=e.maxAzimuthAngle;isFinite(se)&&isFinite(re)&&(se<-Math.PI?se+=de:se>Math.PI&&(se-=de),re<-Math.PI?re+=de:re>Math.PI&&(re-=de),se<=re?d.theta=Math.max(se,Math.min(re,d.theta)):d.theta=d.theta>(se+re)/2?Math.max(se,d.theta):Math.min(re,d.theta)),d.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,d.phi)),d.makeSafe(),e.enableDamping===!0?e.target.addScaledVector(M,e.dampingFactor):e.target.add(M),e.zoomToCursor&&v||e.object.isOrthographicCamera?d.radius=j(d.radius):d.radius=j(d.radius*y),i.setFromSpherical(d),i.applyQuaternion(x),lt.copy(e.target).add(i),e.object.matrixAutoUpdate||e.object.updateMatrix(),e.object.lookAt(e.target),e.enableDamping===!0?(m.theta*=1-e.dampingFactor,m.phi*=1-e.dampingFactor,M.multiplyScalar(1-e.dampingFactor)):(m.set(0,0,0),M.set(0,0,0));let Ee=!1;if(e.zoomToCursor&&v){let Te=null;if(e.object instanceof Re&&e.object.isPerspectiveCamera){const _e=i.length();Te=j(_e*y);const Ce=_e-Te;e.object.position.addScaledVector(K,Ce),e.object.updateMatrixWorld()}else if(e.object.isOrthographicCamera){const _e=new k(Y.x,Y.y,0);_e.unproject(e.object),e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/y)),e.object.updateProjectionMatrix(),Ee=!0;const Ce=new k(Y.x,Y.y,0);Ce.unproject(e.object),e.object.position.sub(Ce).add(_e),e.object.updateMatrixWorld(),Te=i.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),e.zoomToCursor=!1;Te!==null&&(e.screenSpacePanning?e.target.set(0,0,-1).transformDirection(e.object.matrix).multiplyScalar(Te).add(e.object.position):(De.origin.copy(e.object.position),De.direction.set(0,0,-1).transformDirection(e.object.matrix),Math.abs(e.object.up.dot(De.direction))<sn?t.lookAt(e.target):(ft.setFromNormalAndCoplanarPoint(e.object.up,e.target),De.intersectPlane(ft,e.target))))}else e.object instanceof Ie&&e.object.isOrthographicCamera&&(Ee=y!==1,Ee&&(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/y)),e.object.updateProjectionMatrix()));return y=1,v=!1,Ee||W.distanceToSquared(e.object.position)>h||8*(1-ae.dot(e.object.quaternion))>h?(e.dispatchEvent(o),W.copy(e.object.position),ae.copy(e.object.quaternion),Ee=!1,!0):!1}})(),this.connect=i=>{e.domElement=i,e.domElement.style.touchAction="none",e.domElement.addEventListener("contextmenu",st),e.domElement.addEventListener("pointerdown",Oe),e.domElement.addEventListener("pointercancel",pe),e.domElement.addEventListener("wheel",ne)},this.dispose=()=>{var i,u,g,x,W,ae;e.domElement&&(e.domElement.style.touchAction="auto"),(i=e.domElement)==null||i.removeEventListener("contextmenu",st),(u=e.domElement)==null||u.removeEventListener("pointerdown",Oe),(g=e.domElement)==null||g.removeEventListener("pointercancel",pe),(x=e.domElement)==null||x.removeEventListener("wheel",ne),(W=e.domElement)==null||W.ownerDocument.removeEventListener("pointermove",xe),(ae=e.domElement)==null||ae.ownerDocument.removeEventListener("pointerup",pe),e._domElementKeyEvents!==null&&e._domElementKeyEvents.removeEventListener("keydown",$e)};const e=this,o={type:"change"},s={type:"start"},r={type:"end"},a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let l=a.NONE;const h=1e-6,d=new ht,m=new ht;let y=1;const M=new k,w=new Z,L=new Z,R=new Z,H=new Z,F=new Z,U=new Z,V=new Z,E=new Z,A=new Z,K=new k,Y=new Z;let v=!1;const b=[],O={};function we(){return 2*Math.PI/60/60*e.autoRotateSpeed}function q(){return Math.pow(.95,e.zoomSpeed)}function fe(i){e.reverseOrbit||e.reverseHorizontalOrbit?m.theta+=i:m.theta-=i}function P(i){e.reverseOrbit||e.reverseVerticalOrbit?m.phi+=i:m.phi-=i}const D=(()=>{const i=new k;return function(g,x){i.setFromMatrixColumn(x,0),i.multiplyScalar(-g),M.add(i)}})(),T=(()=>{const i=new k;return function(g,x){e.screenSpacePanning===!0?i.setFromMatrixColumn(x,1):(i.setFromMatrixColumn(x,0),i.crossVectors(e.object.up,i)),i.multiplyScalar(g),M.add(i)}})(),N=(()=>{const i=new k;return function(g,x){const W=e.domElement;if(W&&e.object instanceof Re&&e.object.isPerspectiveCamera){const ae=e.object.position;i.copy(ae).sub(e.target);let de=i.length();de*=Math.tan(e.object.fov/2*Math.PI/180),D(2*g*de/W.clientHeight,e.object.matrix),T(2*x*de/W.clientHeight,e.object.matrix)}else W&&e.object instanceof Ie&&e.object.isOrthographicCamera?(D(g*(e.object.right-e.object.left)/e.object.zoom/W.clientWidth,e.object.matrix),T(x*(e.object.top-e.object.bottom)/e.object.zoom/W.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}})();function _(i){e.object instanceof Re&&e.object.isPerspectiveCamera||e.object instanceof Ie&&e.object.isOrthographicCamera?y=i:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function z(i){_(y/i)}function S(i){_(y*i)}function C(i){if(!e.zoomToCursor||!e.domElement)return;v=!0;const u=e.domElement.getBoundingClientRect(),g=i.clientX-u.left,x=i.clientY-u.top,W=u.width,ae=u.height;Y.x=g/W*2-1,Y.y=-(x/ae)*2+1,K.set(Y.x,Y.y,1).unproject(e.object).sub(e.object.position).normalize()}function j(i){return Math.max(e.minDistance,Math.min(e.maxDistance,i))}function $(i){w.set(i.clientX,i.clientY)}function J(i){C(i),V.set(i.clientX,i.clientY)}function ve(i){H.set(i.clientX,i.clientY)}function Fe(i){L.set(i.clientX,i.clientY),R.subVectors(L,w).multiplyScalar(e.rotateSpeed);const u=e.domElement;u&&(fe(2*Math.PI*R.x/u.clientHeight),P(2*Math.PI*R.y/u.clientHeight)),w.copy(L),e.update()}function he(i){E.set(i.clientX,i.clientY),A.subVectors(E,V),A.y>0?z(q()):A.y<0&&S(q()),V.copy(E),e.update()}function Le(i){F.set(i.clientX,i.clientY),U.subVectors(F,H).multiplyScalar(e.panSpeed),N(U.x,U.y),H.copy(F),e.update()}function B(i){C(i),i.deltaY<0?S(q()):i.deltaY>0&&z(q()),e.update()}function I(i){let u=!1;switch(i.code){case e.keys.UP:N(0,e.keyPanSpeed),u=!0;break;case e.keys.BOTTOM:N(0,-e.keyPanSpeed),u=!0;break;case e.keys.LEFT:N(e.keyPanSpeed,0),u=!0;break;case e.keys.RIGHT:N(-e.keyPanSpeed,0),u=!0;break}u&&(i.preventDefault(),e.update())}function ee(){if(b.length==1)w.set(b[0].pageX,b[0].pageY);else{const i=.5*(b[0].pageX+b[1].pageX),u=.5*(b[0].pageY+b[1].pageY);w.set(i,u)}}function X(){if(b.length==1)H.set(b[0].pageX,b[0].pageY);else{const i=.5*(b[0].pageX+b[1].pageX),u=.5*(b[0].pageY+b[1].pageY);H.set(i,u)}}function ue(){const i=b[0].pageX-b[1].pageX,u=b[0].pageY-b[1].pageY,g=Math.sqrt(i*i+u*u);V.set(0,g)}function ge(){e.enableZoom&&ue(),e.enablePan&&X()}function Ge(){e.enableZoom&&ue(),e.enableRotate&&ee()}function te(i){if(b.length==1)L.set(i.pageX,i.pageY);else{const g=Be(i),x=.5*(i.pageX+g.x),W=.5*(i.pageY+g.y);L.set(x,W)}R.subVectors(L,w).multiplyScalar(e.rotateSpeed);const u=e.domElement;u&&(fe(2*Math.PI*R.x/u.clientHeight),P(2*Math.PI*R.y/u.clientHeight)),w.copy(L)}function Pe(i){if(b.length==1)F.set(i.pageX,i.pageY);else{const u=Be(i),g=.5*(i.pageX+u.x),x=.5*(i.pageY+u.y);F.set(g,x)}U.subVectors(F,H).multiplyScalar(e.panSpeed),N(U.x,U.y),H.copy(F)}function ye(i){const u=Be(i),g=i.pageX-u.x,x=i.pageY-u.y,W=Math.sqrt(g*g+x*x);E.set(0,W),A.set(0,Math.pow(E.y/V.y,e.zoomSpeed)),z(A.y),V.copy(E)}function Ne(i){e.enableZoom&&ye(i),e.enablePan&&Pe(i)}function We(i){e.enableZoom&&ye(i),e.enableRotate&&te(i)}function Oe(i){var u,g;e.enabled!==!1&&(b.length===0&&((u=e.domElement)==null||u.ownerDocument.addEventListener("pointermove",xe),(g=e.domElement)==null||g.ownerDocument.addEventListener("pointerup",pe)),Et(i),i.pointerType==="touch"?Pt(i):Ue(i))}function xe(i){e.enabled!==!1&&(i.pointerType==="touch"?xt(i):Ye(i))}function pe(i){var u,g,x;Tt(i),b.length===0&&((u=e.domElement)==null||u.releasePointerCapture(i.pointerId),(g=e.domElement)==null||g.ownerDocument.removeEventListener("pointermove",xe),(x=e.domElement)==null||x.ownerDocument.removeEventListener("pointerup",pe)),e.dispatchEvent(r),l=a.NONE}function Ue(i){let u;switch(i.button){case 0:u=e.mouseButtons.LEFT;break;case 1:u=e.mouseButtons.MIDDLE;break;case 2:u=e.mouseButtons.RIGHT;break;default:u=-1}switch(u){case Ae.DOLLY:if(e.enableZoom===!1)return;J(i),l=a.DOLLY;break;case Ae.ROTATE:if(i.ctrlKey||i.metaKey||i.shiftKey){if(e.enablePan===!1)return;ve(i),l=a.PAN}else{if(e.enableRotate===!1)return;$(i),l=a.ROTATE}break;case Ae.PAN:if(i.ctrlKey||i.metaKey||i.shiftKey){if(e.enableRotate===!1)return;$(i),l=a.ROTATE}else{if(e.enablePan===!1)return;ve(i),l=a.PAN}break;default:l=a.NONE}l!==a.NONE&&e.dispatchEvent(s)}function Ye(i){if(e.enabled!==!1)switch(l){case a.ROTATE:if(e.enableRotate===!1)return;Fe(i);break;case a.DOLLY:if(e.enableZoom===!1)return;he(i);break;case a.PAN:if(e.enablePan===!1)return;Le(i);break}}function ne(i){e.enabled===!1||e.enableZoom===!1||l!==a.NONE&&l!==a.ROTATE||(i.preventDefault(),e.dispatchEvent(s),B(i),e.dispatchEvent(r))}function $e(i){e.enabled===!1||e.enablePan===!1||I(i)}function Pt(i){switch(rt(i),b.length){case 1:switch(e.touches.ONE){case be.ROTATE:if(e.enableRotate===!1)return;ee(),l=a.TOUCH_ROTATE;break;case be.PAN:if(e.enablePan===!1)return;X(),l=a.TOUCH_PAN;break;default:l=a.NONE}break;case 2:switch(e.touches.TWO){case be.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;ge(),l=a.TOUCH_DOLLY_PAN;break;case be.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Ge(),l=a.TOUCH_DOLLY_ROTATE;break;default:l=a.NONE}break;default:l=a.NONE}l!==a.NONE&&e.dispatchEvent(s)}function xt(i){switch(rt(i),l){case a.TOUCH_ROTATE:if(e.enableRotate===!1)return;te(i),e.update();break;case a.TOUCH_PAN:if(e.enablePan===!1)return;Pe(i),e.update();break;case a.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Ne(i),e.update();break;case a.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;We(i),e.update();break;default:l=a.NONE}}function st(i){e.enabled!==!1&&i.preventDefault()}function Et(i){b.push(i)}function Tt(i){delete O[i.pointerId];for(let u=0;u<b.length;u++)if(b[u].pointerId==i.pointerId){b.splice(u,1);return}}function rt(i){let u=O[i.pointerId];u===void 0&&(u=new Z,O[i.pointerId]=u),u.set(i.pageX,i.pageY)}function Be(i){const u=i.pointerId===b[0].pointerId?b[1]:b[0];return O[u.pointerId]}this.dollyIn=(i=q())=>{S(i),e.update()},this.dollyOut=(i=q())=>{z(i),e.update()},this.getScale=()=>y,this.setScale=i=>{_(i),e.update()},this.getZoomScale=()=>q(),n!==void 0&&this.connect(n),this.update()}};const ln=f.forwardRef(({makeDefault:c,camera:t,regress:n,domElement:e,enableDamping:o=!0,keyEvents:s=!1,onChange:r,onStart:a,onEnd:l,...h},d)=>{const m=oe(A=>A.invalidate),y=oe(A=>A.camera),M=oe(A=>A.gl),w=oe(A=>A.events),L=oe(A=>A.setEvents),R=oe(A=>A.set),H=oe(A=>A.get),F=oe(A=>A.performance),U=t||y,V=e||w.connected||M.domElement,E=f.useMemo(()=>new rn(U),[U]);return ot(()=>{E.enabled&&E.update()},-1),f.useEffect(()=>(s&&E.connect(s===!0?V:s),E.connect(V),()=>void E.dispose()),[s,V,n,E,m]),f.useEffect(()=>{const A=v=>{m(),n&&F.regress(),r&&r(v)},K=v=>{a&&a(v)},Y=v=>{l&&l(v)};return E.addEventListener("change",A),E.addEventListener("start",K),E.addEventListener("end",Y),()=>{E.removeEventListener("start",K),E.removeEventListener("end",Y),E.removeEventListener("change",A)}},[r,a,l,E,m,L]),f.useEffect(()=>{if(c){const A=H().controls;return R({controls:E}),()=>R({controls:A})}},[c,E]),f.createElement("primitive",He({ref:d,object:E,enableDamping:o},h))}),cn={idle:[{name:"motion_pose",path:"/assets/animations/08_Motion_Pose.vrma",duration:8,loop:!0},{name:"step",path:"/assets/animations/10_Step.vrma",duration:3,loop:!0},{name:"sit",path:"/assets/animations/15_Sit.vrma",duration:5,loop:!0}],greeting:[{name:"greeting",path:"/assets/animations/02_Greeting.vrma",duration:3,loop:!1},{name:"hello",path:"/assets/animations/11_Hello.vrma",duration:3,loop:!1},{name:"show_full_body",path:"/assets/animations/01_Show_Full_Body.vrma",duration:10,loop:!1}],pose:[{name:"model_pose",path:"/assets/animations/06_Model_Pose.vrma",duration:5,loop:!0},{name:"peace_sign",path:"/assets/animations/03_Peace_Sign.vrma",duration:4,loop:!1},{name:"shoot",path:"/assets/animations/04_Shoot.vrma",duration:3,loop:!1}],action:[{name:"drink_water",path:"/assets/animations/13_Drink_Water.vrma",duration:5,loop:!1},{name:"smartphone",path:"/assets/animations/12_Smartphone.vrma",duration:4,loop:!0},{name:"squat",path:"/assets/animations/07_Squat.vrma",duration:4,loop:!0},{name:"warm_up",path:"/assets/animations/14_Warm_Up.vrma",duration:4,loop:!0}],reaction:[{name:"bow",path:"/assets/animations/09_Bow.vrma",duration:3,loop:!1},{name:"step",path:"/assets/animations/10_Step.vrma",duration:2,loop:!1}],dance:[{name:"spin",path:"/assets/animations/05_Spin.vrma",duration:6,loop:!0}],special:[{name:"smile_world",path:"/assets/animations/17_Smile_World.vrma",duration:15,loop:!0},{name:"lovely_world",path:"/assets/animations/18_Lovely_World.vrma",duration:15,loop:!0},{name:"cute_sparkle_world",path:"/assets/animations/19_Cute_Sparkle_World.vrma",duration:15,loop:!0},{name:"connected_world",path:"/assets/animations/20_Connected_World.vrma",duration:15,loop:!0}]},hn={idle:{category:"idle",preference:"motion_pose",fallback:"motion_pose"},speaking:{category:"idle",preference:"motion_pose",fallback:"motion_pose"},thinking:{category:"idle",preference:"motion_pose",fallback:"motion_pose"},listening:{category:"idle",preference:"motion_pose",fallback:"motion_pose"},dancing:{category:"dance",preference:"spin",fallback:"spin"},greeting:{category:"greeting",preference:"greeting",fallback:"hello"},happy:{category:"greeting",preference:"hello",fallback:"motion_pose"},surprised:{category:"reaction",preference:"bow",fallback:"motion_pose"},sleeping:{category:"idle",preference:"sit",fallback:"motion_pose"},dragging:{category:"pose",preference:"model_pose",fallback:"motion_pose"},sitting:{category:"idle",preference:"sit",fallback:"motion_pose"},posing:{category:"pose",preference:"model_pose",fallback:"peace_sign"},celebrating:{category:"special",preference:"random",fallback:"smile_world"},working:{category:"action",preference:"smartphone",fallback:"motion_pose"},exercising:{category:"action",preference:"warm_up",fallback:"squat"}};class un{constructor(){this.catalog=cn,this.stateMap=hn,this.loadedAnimations=new Map}getCategory(t){return this.catalog[t]||[]}getCategories(){return Object.keys(this.catalog)}getAnimation(t){for(const n of Object.values(this.catalog)){const e=n.find(o=>o.name===t);if(e)return e}return null}getAnimationForState(t){const n=this.stateMap[t]||this.stateMap.idle,e=this.catalog[n.category]||this.catalog.idle;if(n.preference==="random"){const s=Math.floor(Math.random()*e.length);return e[s]||this.getAnimation(n.fallback)}return e.find(s=>s.name===n.preference)||this.getAnimation(n.fallback)||e[0]}getRandomFromCategory(t){const n=this.catalog[t];return!n||n.length===0?null:n[Math.floor(Math.random()*n.length)]}getAllAnimationNames(){const t=[];for(const n of Object.values(this.catalog))for(const e of n)t.includes(e.name)||t.push(e.name);return t}getTotalCount(){let t=0;for(const n of Object.values(this.catalog))t+=n.length;return t}getIdleGestures(){return[...this.catalog.greeting,...this.catalog.reaction]}}let Ke=null;function vt(){return Ke||(Ke=new un),Ke}const le={IDLE:"idle",PLAYING:"playing",PAUSED:"paused"};class dn{constructor(){this.duration=0,this.restHipsPosition=new k,this.humanoidTracks={translation:new Map,rotation:new Map},this.expressionTracks={preset:new Map,custom:new Map},this.lookAtTrack=null}}class mn extends Nt{constructor(t){super(),this._lookAt=t,this._quaternion=new tt}get quaternion(){return this._quaternion}set quaternion(t){if(this._quaternion.copy(t),this._lookAt){const n=new Ot().setFromQuaternion(t,"YXZ");this._lookAt.yaw=ut.radToDeg(n.y),this._lookAt.pitch=ut.radToDeg(n.x)}}}const ke=class ke{constructor(){this.vrm=null,this.mixer=null,this.animations=new Map,this.currentAnimation=null,this.state=le.IDLE,this.lookAtProxy=null,this.blendDuration=.5,this.clock=new yt,this.GLTFLoader=null,this.VRMAnimationLoaderPlugin=null,this.loaderReady=!1,this.library=vt(),this.currentState="idle",this.isInitialized=!1,this.loadingAnimations=new Set,this.lastWatchdogTime=0,this.watchdogCooldown=2,this.animationCycleTimer=0,this.animationCycleDuration=20+Math.random()*20,this.enableRandomCycling=!0,this.fallbackPoseApplied=!1}initialize(t){var n;return t?(this.vrm=t,this.mixer=new At(t.scene),t.lookAt&&(this.lookAtProxy=new mn(t.lookAt),this.lookAtProxy.name="VRMLookAtQuaternionProxy",t.scene.add(this.lookAtProxy)),this.isInitialized=!0,console.log("[VRMAAnimationService] Initialized with VRM:",(n=t.meta)==null?void 0:n.name),this._loadStateAnimations("idle"),!0):(console.error("[VRMAAnimationService] Cannot initialize without VRM"),!1)}async _ensureLoader(){if(this.loaderReady)return!0;try{const[t]=await Promise.all([Ve(()=>import("./GLTFLoader-QrdB9JU-.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)]);return this.GLTFLoader=t.GLTFLoader,this.loaderReady=!0,!0}catch(t){return console.error("[VRMAAnimationService] Failed to load dependencies:",t),!1}}async loadAnimation(t,n){return this.vrm?await this._ensureLoader()?new Promise((e,o)=>{const s=new this.GLTFLoader;s.crossOrigin="anonymous",s.register(r=>new fn(r)),s.load(t,r=>{const a=r.userData.vrmAnimations;if(!a||a.length===0){console.warn("[VRMAAnimationService] No VRM animations found in",t),e(!1);return}const l=a[0],h=this._createAnimationClip(l,this.vrm);if(!h){console.error("[VRMAAnimationService] Failed to create animation clip"),e(!1);return}const d=this.mixer.clipAction(h);this.animations.set(n,{vrmAnimation:l,clip:h,action:d,duration:h.duration}),console.log(`[VRMAAnimationService] Loaded animation: ${n} (${h.duration.toFixed(2)}s)`),e(!0)},r=>{console.log(`[VRMAAnimationService] Loading ${n}: ${(r.loaded/r.total*100).toFixed(1)}%`)},r=>{console.error("[VRMAAnimationService] Load error:",r),o(r)})}):!1:(console.error("[VRMAAnimationService] VRM not initialized"),!1)}_createAnimationClip(t,n){var s;const e=[],o=this._createHumanoidTracks(t,n.humanoid,((s=n.meta)==null?void 0:s.metaVersion)||"1");if(e.push(...o.translation.values()),e.push(...o.rotation.values()),n.expressionManager){const r=this._createExpressionTracks(t,n.expressionManager);e.push(...r.preset.values()),e.push(...r.custom.values())}if(n.lookAt&&this.lookAtProxy&&t.lookAtTrack){const r=t.lookAtTrack.clone();r.name=`${this.lookAtProxy.name}.quaternion`,e.push(r)}return e.length===0?(console.warn("[VRMAAnimationService] No tracks created from VRM animation"),null):new bt("VRMAClip",t.duration,e)}_createHumanoidTracks(t,n,e){var r,a,l;const o=new Map,s=new Map;for(const[h,d]of t.humanoidTracks.rotation.entries()){const m=n.getNormalizedBoneNode(h);if(!m)continue;const y=new Mt(`${m.name}.quaternion`,d.times,d.values.map((M,w)=>e==="0"&&w%2===0?-M:M));s.set(h,y)}for(const[h,d]of t.humanoidTracks.translation.entries()){const m=n.getNormalizedBoneNode(h);if(!m)continue;const y=t.restHipsPosition.y||1,w=(((l=(a=(r=n.normalizedRestPose)==null?void 0:r.hips)==null?void 0:a.position)==null?void 0:l[1])||1)/y,L=d.clone();L.values=L.values.map((R,H)=>(e==="0"&&H%3!==1?-R:R)*w),L.name=`${m.name}.position`,o.set(h,L)}return{translation:o,rotation:s}}_createExpressionTracks(t,n){var s,r;const e=new Map,o=new Map;for(const[a,l]of t.expressionTracks.preset.entries()){const h=(s=n.getExpressionTrackName)==null?void 0:s.call(n,a);if(h){const d=l.clone();d.name=h,e.set(a,d)}}for(const[a,l]of t.expressionTracks.custom.entries()){const h=(r=n.getExpressionTrackName)==null?void 0:r.call(n,a);if(h){const d=l.clone();d.name=h,o.set(a,d)}}return{preset:e,custom:o}}play(t,n={}){const e=this.animations.get(t);if(!e)return console.warn(`[VRMAAnimationService] Animation not found: ${t}`),!1;if(this.currentAnimation===t&&this.state===le.PLAYING){const l=e.action;if(l&&l.isRunning()&&l.loop===me)return n.timeScale&&(l.timeScale=n.timeScale),!0}const{loop:o=me,fadeIn:s=this.blendDuration,timeScale:r=1}=n,a=e.action;if(a.enabled=!0,a.setEffectiveTimeScale(r),a.setEffectiveWeight(1),a.setLoop(o,1/0),this.currentAnimation&&this.currentAnimation!==t){const l=this.animations.get(this.currentAnimation),h=l==null?void 0:l.action;h&&h.isRunning()?(a.reset(),a.play(),h.crossFadeTo(a,s,!0)):(a.reset(),a.play(),a.fadeIn(s))}else a.reset(),a.play(),a.fadeIn(s);return this.currentAnimation=t,this.state=le.PLAYING,console.log(`[VRMAAnimationService] Playing: ${t} (Crossfade: ${s}s)`),!0}stop(t=this.blendDuration){if(this.currentAnimation){const n=this.animations.get(this.currentAnimation);n!=null&&n.action&&n.action.fadeOut(t),this.currentAnimation=null}this.state=le.IDLE}pause(){if(this.currentAnimation){const t=this.animations.get(this.currentAnimation);t!=null&&t.action&&(t.action.paused=!0),this.state=le.PAUSED}}resume(){if(this.currentAnimation&&this.state===le.PAUSED){const t=this.animations.get(this.currentAnimation);t!=null&&t.action&&(t.action.paused=!1),this.state=le.PLAYING}}update(t){if(this.mixer&&this.mixer.update(t),this.lastWatchdogTime+=t,this.lastWatchdogTime>=this.watchdogCooldown&&(this.lastWatchdogTime=0,this.isInitialized&&this.vrm))if(this.currentAnimation){const n=this.animations.get(this.currentAnimation);n!=null&&n.action&&!n.action.isRunning()&&this.state===le.PLAYING&&(console.log("[VRMAAnimationService] Animation stopped, restarting"),this._playRandomAnimation().catch(()=>this._applyNaturalRestPose()))}else this.state!==le.PLAYING&&(console.log("[VRMAAnimationService] No animation, trying random"),this._playRandomAnimation().catch(()=>this._applyNaturalRestPose()));this.enableRandomCycling&&this.isInitialized&&this.currentState==="idle"&&(this.animationCycleTimer+=t,this.animationCycleTimer>=this.animationCycleDuration&&(this.animationCycleTimer=0,this.animationCycleDuration=20+Math.random()*20,console.log("[VRMAAnimationService] Cycling to random animation"),this._playRandomAnimation().catch(()=>{})))}async _playRandomAnimation(){const t=this.library.getAllAnimationNames();if(t.length===0)throw new Error("No animations available");const n=t[Math.floor(Math.random()*t.length)],e=this.library.getAnimation(n);if(!e)throw new Error(`Animation ${n} not found`);if(!this.hasAnimation(e.name)&&!await this.loadAnimation(e.path,e.name))throw new Error(`Failed to load ${e.name}`);return this.play(e.name,{loop:e.loop?me:je,fadeIn:this.blendDuration})}_applyNaturalRestPose(){var n;if(!((n=this.vrm)!=null&&n.humanoid)||this.fallbackPoseApplied)return;console.log("[VRMAAnimationService] Applying natural rest pose (fallback)");const t={leftUpperArm:{x:.1,y:0,z:1.2},rightUpperArm:{x:.1,y:0,z:-1.2},leftLowerArm:{x:.15,y:0,z:0},rightLowerArm:{x:.15,y:0,z:0},leftHand:{x:0,y:0,z:0},rightHand:{x:0,y:0,z:0},leftShoulder:{x:0,y:0,z:0},rightShoulder:{x:0,y:0,z:0},hips:{x:0,y:0,z:0},spine:{x:0,y:0,z:0},chest:{x:0,y:0,z:0},upperChest:{x:0,y:0,z:0},neck:{x:0,y:0,z:0},head:{x:0,y:0,z:0},leftUpperLeg:{x:0,y:0,z:0},rightUpperLeg:{x:0,y:0,z:0},leftLowerLeg:{x:0,y:0,z:0},rightLowerLeg:{x:0,y:0,z:0},leftFoot:{x:0,y:0,z:0},rightFoot:{x:0,y:0,z:0}};for(const[e,o]of Object.entries(t))try{const s=this.vrm.humanoid.getNormalizedBoneNode(e);s&&s.rotation.set(o.x,o.y,o.z)}catch{}this.fallbackPoseApplied=!0,console.log("[VRMAAnimationService] Natural rest pose applied successfully")}getAnimationNames(){return Array.from(this.animations.keys())}hasAnimation(t){return this.animations.has(t)}getState(){return{state:this.state,currentAnimation:this.currentAnimation,animationCount:this.animations.size,currentAvatarState:this.currentState}}async setState(t,n={}){if(!this.isInitialized)return console.warn("[VRMAAnimationService] Not initialized yet"),!1;this.currentState=t;const e=this.library.getAnimationForState(t);if(!e)return console.warn(`[VRMAAnimationService] No animation found for state: ${t}`),!1;console.log(`[VRMAAnimationService] Setting state: ${t}, animation: ${e.name}`);try{if(!this.hasAnimation(e.name)&&!await this.loadAnimation(e.path,e.name))return console.warn(`[VRMAAnimationService] Failed to load animation: ${e.name}`),!1;const o={loop:e.loop?me:je,fadeIn:n.fadeIn??this.blendDuration,timeScale:n.timeScale??1,...n};return this.play(e.name,o)}catch(o){return console.error(`[VRMAAnimationService] Error setting state ${t}:`,o),!1}}async _loadStateAnimations(t){const n=this.library.stateMap[t];if(!n)return;const e=this.library.catalog[n.category];if(e)for(const o of e)!this.hasAnimation(o.name)&&!this.loadingAnimations.has(o.name)&&(this.loadingAnimations.add(o.name),this.loadAnimation(o.path,o.name).then(()=>this.loadingAnimations.delete(o.name)).catch(()=>this.loadingAnimations.delete(o.name)))}async playRandomGesture(){const t=this.library.getIdleGestures();if(t.length===0)return!1;const n=t[Math.floor(Math.random()*t.length)];this.hasAnimation(n.name)||await this.loadAnimation(n.path,n.name);const e=this.currentAnimation;return this.play(n.name,{loop:je,fadeIn:.3}),setTimeout(()=>{e&&this.hasAnimation(e)&&this.play(e,{loop:me,fadeIn:.3})},(n.duration||3)*1e3),!0}async playDance(t=null){let n;return t?n=this.library.getAnimation(t):n=this.library.getRandomFromCategory("dance"),n?(this.hasAnimation(n.name)||await this.loadAnimation(n.path,n.name),this.currentState="dancing",this.play(n.name,{loop:me,fadeIn:.5})):(console.warn("[VRMAAnimationService] No dance animation found"),!1)}async setEmotion(t,n={}){var o,s;if(!this.isInitialized)return console.warn("[VRMAAnimationService] Not initialized"),!1;const e=ke.EMOTION_ANIMATIONS[t]||ke.EMOTION_ANIMATIONS.neutral;console.log(`[VRMAAnimationService] Setting emotion: ${t}`);try{const r=e.animations[Math.floor(Math.random()*e.animations.length)];let a=this.library.getAnimation(r);if(a||(a=this.library.getRandomFromCategory(e.category)),a&&!this.hasAnimation(a.name)&&await this.loadAnimation(a.path,a.name),a&&this.hasAnimation(a.name)){const l=n.blendDuration??.8;this.play(a.name,{loop:n.loop??me,fadeIn:l})}return(o=this.vrm)!=null&&o.expressionManager&&await this._blendToExpression(e.expression,e.expressionIntensity,n.expressionDuration??2e3),e.lookUp&&((s=this.vrm)!=null&&s.lookAt)&&(this.vrm.lookAt.pitch=-15),this.currentEmotion=t,!0}catch(r){return console.error(`[VRMAAnimationService] Error setting emotion ${t}:`,r),!1}}async _blendToExpression(t,n,e=2e3){var d;if(!((d=this.vrm)!=null&&d.expressionManager))return;const o=this.vrm.expressionManager,s=Date.now(),r=o.getValue(t)||0,a=n-r,l=["happy","sad","angry","surprised","relaxed"],h={};return l.forEach(m=>{m!==t&&(h[m]=o.getValue(m)||0)}),new Promise(m=>{const y=()=>{const M=Date.now()-s,w=Math.min(M/e,1),L=w<.5?2*w*w:1-Math.pow(-2*w+2,2)/2;o.setValue(t,r+a*L),l.forEach(R=>{R!==t&&h[R]&&o.setValue(R,h[R]*(1-L))}),w<1?requestAnimationFrame(y):m()};y()})}getCurrentEmotion(){return this.currentEmotion||"neutral"}subscribeToEmotionChanges(t){typeof t=="function"&&setInterval(async()=>{try{const n=await t();n&&n!==this.currentEmotion&&this.setEmotion(n)}catch{}},500)}dispose(){var t;this.stop(0),this.mixer&&(this.mixer.stopAllAction(),this.mixer=null),this.lookAtProxy&&((t=this.vrm)!=null&&t.scene)&&this.vrm.scene.remove(this.lookAtProxy),this.animations.clear(),this.vrm=null,this.lookAtProxy=null,this.currentAnimation=null,this.currentState="idle",this.currentEmotion="neutral",this.isInitialized=!1,this.fallbackPoseApplied=!1,this.loadingAnimations.clear(),console.log("[VRMAAnimationService] Disposed")}};ct(ke,"EMOTION_ANIMATIONS",{happy:{animations:["greeting","hello"],category:"greeting",expression:"happy",expressionIntensity:.8},excited:{animations:["spin","peace_sign","shoot"],category:"action",expression:"happy",expressionIntensity:1},sad:{animations:["bow"],category:"reaction",expression:"sad",expressionIntensity:.7},thinking:{animations:["model_pose","smartphone"],category:"idle",expression:"neutral",expressionIntensity:.5,lookUp:!0},neutral:{animations:["model_pose","hello","smartphone"],category:"idle",expression:"neutral",expressionIntensity:.3},concerned:{animations:["bow"],category:"reaction",expression:"sad",expressionIntensity:.5},playful:{animations:["spin","peace_sign","shoot"],category:"action",expression:"happy",expressionIntensity:.6}});let it=ke,fn=class{constructor(t){this.parser=t}get name(){return"VRMC_vrm_animation"}async afterRoot(t){var l;const n=t.parser.json,e=n.extensionsUsed;if(!e||!e.includes(this.name))return;const o=(l=n.extensions)==null?void 0:l[this.name];if(!o)return;const s=this._createNodeMap(o),a=t.animations.map((h,d)=>{const m=n.animations[d];return this._parseAnimation(h,m,s)});t.userData.vrmAnimations=a}_createNodeMap(t){var l,h,d,m;const n=new Map,e=new Map,o=(l=t.humanoid)==null?void 0:l.humanBones;o&&Object.entries(o).forEach(([y,M])=>{const w=M==null?void 0:M.node;w!=null&&n.set(w,y)});const s=(h=t.expressions)==null?void 0:h.preset;s&&Object.entries(s).forEach(([y,M])=>{const w=M==null?void 0:M.node;w!=null&&e.set(w,y)});const r=(d=t.expressions)==null?void 0:d.custom;r&&Object.entries(r).forEach(([y,M])=>{const{node:w}=M;e.set(w,y)});const a=((m=t.lookAt)==null?void 0:m.node)??null;return{humanoidIndexToName:n,expressionsIndexToName:e,lookAtIndex:a}}_parseAnimation(t,n,e){const o=t.tracks,s=n.channels,r=new dn;return r.duration=t.duration,s.forEach((a,l)=>{const{node:h,path:d}=a.target,m=o[l];if(h==null)return;const y=e.humanoidIndexToName.get(h);if(y!=null){d==="translation"?y==="hips"&&r.humanoidTracks.translation.set(y,m.clone()):d==="rotation"&&r.humanoidTracks.rotation.set(y,m.clone());return}const M=e.expressionsIndexToName.get(h);if(M!=null){if(d==="translation"){const w=m.times,L=new Float32Array(m.values.length/3);for(let F=0;F<L.length;F++)L[F]=m.values[3*F];const R=new Ct(`${M}.weight`,w,L);["happy","angry","sad","relaxed","surprised","aa","ih","ou","ee","oh","blink","blinkLeft","blinkRight","lookUp","lookDown","lookLeft","lookRight","neutral"].includes(M)?r.expressionTracks.preset.set(M,R):r.expressionTracks.custom.set(M,R)}return}h===e.lookAtIndex&&d==="rotation"&&(r.lookAtTrack=m.clone())}),r}},Ze=null;const pn=()=>(Ze||(Ze=new it),Ze),Me={HEAD:{radius:.3,trigger:"headPat"},LEFT_HAND:{radius:.25,trigger:"grabLeft"},RIGHT_HAND:{radius:.25,trigger:"grabRight"}};class gn{constructor(){this.screenPosition={x:0,y:0},this.normalizedPosition={x:0,y:0},this.worldPosition=new k,this.avatarPosition=new k(0,0,0),this.headPosition=new k(0,1.5,0),this.leftHandPosition=new k(-.3,1,0),this.rightHandPosition=new k(.3,1,0),this.isTracking=!1,this.lastUpdateTime=0,this.updateInterval=16,this.currentInteraction=null,this.interactionCallbacks=new Set,this.lookAtTarget=new k(0,1.5,2),this.smoothLookAt=new k(0,1.5,2),this.lookAtSmoothing=.1,this.isGrabbingLeft=!1,this.isGrabbingRight=!1,this.grabThreshold=.3,this.windowBounds={x:0,y:0,width:200,height:300},this._onMouseMove=this._onMouseMove.bind(this),this._onElectronMouseUpdate=this._onElectronMouseUpdate.bind(this)}initialize(t={}){var o;const{windowBounds:n=this.windowBounds,useElectronTracking:e=!0}=t;return this.windowBounds=n,typeof window<"u"&&window.addEventListener("mousemove",this._onMouseMove),e&&((o=window.nizhal)!=null&&o.on)&&(window.nizhal.on("mouse:position",this._onElectronMouseUpdate),window.nizhal.invoke("mouse:startTracking").catch(()=>{console.log("[MouseInteraction] Electron mouse tracking not available")})),this.isTracking=!0,console.log("[MouseInteractionService] Initialized"),!0}_onMouseMove(t){const n=Date.now();n-this.lastUpdateTime<this.updateInterval||(this.lastUpdateTime=n,this.normalizedPosition.x=t.clientX/window.innerWidth*2-1,this.normalizedPosition.y=-(t.clientY/window.innerHeight)*2+1,this._updateLookAtTarget(),this._checkInteractions())}_onElectronMouseUpdate(t){const{x:n,y:e,screenWidth:o,screenHeight:s}=t;this.screenPosition.x=n,this.screenPosition.y=e;const r=n-this.windowBounds.x,a=e-this.windowBounds.y;this.normalizedPosition.x=r/this.windowBounds.width*2-1,this.normalizedPosition.y=-(a/this.windowBounds.height)*2+1,this._updateLookAtTarget(),this._checkInteractions()}_updateLookAtTarget(){this.lookAtTarget.set(this.normalizedPosition.x*2,1.5+this.normalizedPosition.y*.5,2),this.smoothLookAt.lerp(this.lookAtTarget,this.lookAtSmoothing)}_checkInteractions(){const t=new k(this.normalizedPosition.x*.5+this.avatarPosition.x,1+this.normalizedPosition.y*.8,.5),n=t.distanceTo(this.headPosition);if(n<Me.HEAD.radius){this._triggerInteraction(Me.HEAD.trigger,n);return}const e=t.distanceTo(this.leftHandPosition);if(e<Me.LEFT_HAND.radius){this.isGrabbingLeft=!0,this._triggerInteraction(Me.LEFT_HAND.trigger,e);return}else this.isGrabbingLeft=!1;const o=t.distanceTo(this.rightHandPosition);if(o<Me.RIGHT_HAND.radius){this.isGrabbingRight=!0,this._triggerInteraction(Me.RIGHT_HAND.trigger,o);return}else this.isGrabbingRight=!1;this.currentInteraction=null}_triggerInteraction(t,n){this.currentInteraction!==t&&(this.currentInteraction=t,console.log(`[MouseInteraction] Triggered: ${t}`),this.interactionCallbacks.forEach(e=>{try{e({type:t,distance:n})}catch(o){console.error("[MouseInteraction] Callback error:",o)}}))}getLookAtTarget(){return this.smoothLookAt.clone()}getHeadRotation(){const t=this.normalizedPosition.x*.4,n=this.normalizedPosition.y*.2;return{yaw:t,pitch:n}}getEyeRotation(){const t=this.normalizedPosition.x*.5,n=this.normalizedPosition.y*.3;return{leftYaw:t,leftPitch:n,rightYaw:t,rightPitch:n}}getHandReachTarget(t){return t==="left"&&this.isGrabbingLeft?new k(this.normalizedPosition.x*.4,1+this.normalizedPosition.y*.3,.3):t==="right"&&this.isGrabbingRight?new k(this.normalizedPosition.x*.4,1+this.normalizedPosition.y*.3,.3):null}updateAvatarPositions(t){if(!(t!=null&&t.humanoid))return;const n=t.humanoid.getNormalizedBoneNode("head");n&&n.getWorldPosition(this.headPosition);const e=t.humanoid.getNormalizedBoneNode("leftHand");e&&e.getWorldPosition(this.leftHandPosition);const o=t.humanoid.getNormalizedBoneNode("rightHand");o&&o.getWorldPosition(this.rightHandPosition),t.scene&&t.scene.getWorldPosition(this.avatarPosition)}setWindowBounds(t){this.windowBounds=t}onInteraction(t){return this.interactionCallbacks.add(t),()=>this.interactionCallbacks.delete(t)}isCursorNearAvatar(){return Math.abs(this.normalizedPosition.x)<1.5&&Math.abs(this.normalizedPosition.y)<1.5}stop(){var t;typeof window<"u"&&window.removeEventListener("mousemove",this._onMouseMove),(t=window.nizhal)!=null&&t.invoke&&window.nizhal.invoke("mouse:stopTracking").catch(()=>{}),this.isTracking=!1}dispose(){this.stop(),this.interactionCallbacks.clear(),console.log("[MouseInteractionService] Disposed")}}let Xe=null;const yn=()=>(Xe||(Xe=new gn),Xe);class An{constructor(){this.raycaster=new Dt,this.pointer=new Z,this.boneMap={head:"head",neck:"head",chest:"chest",spine:"chest",upperChest:"chest",hips:"chest",leftHand:"hand_l",rightHand:"hand_r",leftLowerArm:"hand_l",rightLowerArm:"hand_r"},this.interactions={head:{expression:"happy",message:["Pat pat!","Hehe!","That feels nice.","You are kind."],mood:"happy"},chest:{expression:"surprised",message:["Hey!","Poke!","Tickles!","What was that?"],mood:"playful"},hand_l:{expression:"happy",message:["High five!","Holding hands?","Hello!","Wave!"],mood:"friendly"},hand_r:{expression:"happy",message:["High five!","Shake hands?","Greetings!","Hello!"],mood:"friendly"}},this.lastTouchTime=0,this.touchCooldown=1e3}handleTouch(t,n){const e=Date.now();if(e-this.lastTouchTime<this.touchCooldown)return;let o=t.object,s=null;if(o.name){const a=o.name.toLowerCase();for(const l of Object.keys(this.boneMap))if(a.includes(l.toLowerCase())){s=l;break}}if(!s&&n.humanoid,!s){const a=t.point,h=n.scene.worldToLocal(a.clone());h.y>1.3?s="head":h.y>.8?s="chest":s="hips"}const r=this.boneMap[s];r&&(this.triggerReaction(r),this.lastTouchTime=e,t.stopPropagation())}triggerReaction(t){const n=this.interactions[t]||this.interactions.head;let e=t;(t==="hand_l"||t==="hand_r")&&(e="hands");const o=Ft.getTouchMessage(e);window.nizhal&&window.nizhal.invoke&&window.nizhal.invoke("persona:updateMood",n.mood).catch(()=>{}),dt.messageCallback&&dt.messageCallback(o)}}const gt=new An,ze={LOW:0,NORMAL:1,HIGH:2},ie={IDLE:"idle",GREETING:"greeting",CELEBRATING:"celebrating",THINKING:"thinking",RELAXING:"relaxing"},ce={CLICK:"click",DOUBLE_CLICK:"double_click",HOVER:"hover",DRAG_START:"drag_start",DRAG_END:"drag_end",LONG_PRESS:"long_press"};class bn{constructor(){this.vrm=null,this.mixer=null,this.library=vt(),this.currentAnimation=null,this.animationQueue=[],this.isPlaying=!1,this.isInitialized=!1,this.recentAnimations=[],this.maxRecentHistory=5,this.currentScenario=ie.IDLE,this.lastAnimationChange=Date.now(),this.idleCycleDuration=25e3+Math.random()*15e3,this.lastIdleCycleTime=Date.now(),this.blendDuration=.5,this.loadedAnimations=new Map,this.loadingPromises=new Map,this.GLTFLoader=null,this.loaderReady=!1,this.onAnimationStart=null,this.onAnimationEnd=null,console.log("[AdvancedAnimationEngine] Created")}initialize(t){var n;return t?(this.vrm=t,this.mixer=new At(t.scene),this.isInitialized=!0,this.mixer.addEventListener("finished",e=>{this._onAnimationFinished(e)}),console.log("[AdvancedAnimationEngine] Initialized with VRM:",(n=t.meta)==null?void 0:n.name),this.setScenario(ie.IDLE),!0):(console.error("[AdvancedAnimationEngine] Cannot initialize without VRM"),!1)}async _ensureLoader(){if(this.loaderReady)return!0;try{const t=await Ve(()=>import("./GLTFLoader-QrdB9JU-.js"),__vite__mapDeps([0,1,2,3]),import.meta.url);return this.GLTFLoader=t.GLTFLoader,this.loaderReady=!0,!0}catch(t){return console.error("[AdvancedAnimationEngine] Failed to load GLTFLoader:",t),!1}}async loadAnimation(t,n){if(this.loadedAnimations.has(n))return this.loadedAnimations.get(n);if(this.loadingPromises.has(n))return this.loadingPromises.get(n);const e=this._loadAnimationInternal(t,n);this.loadingPromises.set(n,e);try{const o=await e;return this.loadingPromises.delete(n),o}catch(o){throw this.loadingPromises.delete(n),o}}async _loadAnimationInternal(t,n){return!this.vrm||!await this._ensureLoader()?null:new Promise((e,o)=>{const s=new this.GLTFLoader;s.crossOrigin="anonymous",s.register(r=>new Mn(r)),s.load(t,r=>{const a=r.userData.vrmAnimations;if(!a||a.length===0){console.warn("[AdvancedAnimationEngine] No VRM animations in",t),e(null);return}const l=a[0],h=this._createAnimationClip(l,this.vrm);if(!h){e(null);return}const d=this.mixer.clipAction(h),m={name:n,clip:h,action:d,duration:h.duration};this.loadedAnimations.set(n,m),console.log(`[AdvancedAnimationEngine] Loaded: ${n} (${h.duration.toFixed(2)}s)`),e(m)},void 0,r=>{console.error("[AdvancedAnimationEngine] Load error:",r),o(r)})})}_createAnimationClip(t,n){const e=[];for(const[o,s]of t.humanoidTracks.rotation.entries()){const r=n.humanoid.getNormalizedBoneNode(o);if(!r)continue;const a=new Mt(`${r.name}.quaternion`,s.times,s.values);e.push(a)}for(const[o,s]of t.humanoidTracks.translation.entries()){const r=n.humanoid.getNormalizedBoneNode(o);if(!r)continue;const a=new zt(`${r.name}.position`,s.times,s.values);e.push(a)}return e.length===0?null:new bt("VRMAClip",t.duration,e)}async setScenario(t){this.currentScenario=t,console.log(`[AdvancedAnimationEngine] Scenario: ${t}`);const n=this._selectAnimationForScenario(t);n&&await this.playAnimation(n.name,{priority:ze.NORMAL,loop:n.loop})}async handleInteraction(t){console.log(`[AdvancedAnimationEngine] Interaction: ${t}`);const n=this._selectAnimationForInteraction(t);n&&await this.playAnimation(n.name,{priority:ze.HIGH,loop:!1,returnToIdle:!0})}async playAnimation(t,n={}){var d;const{priority:e=ze.NORMAL,loop:o=!0,fadeIn:s=this.blendDuration,returnToIdle:r=!1}=n,a=this.library.getAnimation(t);if(!a)return console.warn(`[AdvancedAnimationEngine] Animation not found: ${t}`),!1;let l=this.loadedAnimations.get(t);if(!l&&(l=await this.loadAnimation(a.path,t),!l))return!1;if(this.currentAnimation&&this.currentAnimation!==t){const m=this.loadedAnimations.get(this.currentAnimation);m!=null&&m.action&&m.action.fadeOut(s)}const{action:h}=l;return h.reset(),h.setLoop(o?me:je,1/0),h.clampWhenFinished=!o,h.fadeIn(s),h.play(),this.currentAnimation=t,this.isPlaying=!0,this.lastAnimationChange=Date.now(),this._addToRecentHistory(t),r&&!o&&setTimeout(()=>{this.setScenario(ie.IDLE)},l.duration*1e3+200),console.log(`[AdvancedAnimationEngine] Playing: ${t}`),(d=this.onAnimationStart)==null||d.call(this,t),!0}async playRandom(){const t=this.library.getAllAnimationNames(),n=t.filter(o=>!this.recentAnimations.includes(o));if(n.length===0){const o=Math.floor(Math.random()*t.length);return this.playAnimation(t[o])}const e=Math.floor(Math.random()*n.length);return this.playAnimation(n[e])}_selectAnimationForScenario(t){switch(t){case ie.GREETING:return this.library.getRandomFromCategory("greeting")||this.library.getAnimation("hello");case ie.THINKING:return this.library.getAnimation("thinking")||this.library.getAnimation("humidai");case ie.CELEBRATING:return this.library.getRandomFromCategory("dance")||this.library.getAnimation("cheer");case ie.RELAXING:return this.library.getRandomFromCategory("action")||this.library.getAnimation("smartphone");case ie.IDLE:default:return this._selectSmartIdle()}}_selectAnimationForInteraction(t){switch(t){case ce.CLICK:return this.library.getAnimation("greeting")||this.library.getRandomFromCategory("greeting");case ce.DOUBLE_CLICK:return this.library.getRandomFromCategory("dance")||this.library.getAnimation("spin");case ce.HOVER:return this.library.getAnimation("peace_sign")||this.library.getAnimation("show_full_body");case ce.DRAG_START:return this.library.getAnimation("surprise")||this.library.getAnimation("gatan");case ce.DRAG_END:return this.library.getAnimation("model_pose")||this.library.getRandomFromCategory("pose");case ce.LONG_PRESS:return this.library.getRandomFromCategory("special");default:return null}}_selectSmartIdle(){const t=this.library.getCategory("idle"),n=this.library.getCategory("pose"),e=[...t,...n],o=e.filter(s=>!this.recentAnimations.includes(s.name));return o.length===0?(this.recentAnimations=[],e[Math.floor(Math.random()*e.length)]):o[Math.floor(Math.random()*o.length)]}_addToRecentHistory(t){this.recentAnimations.push(t),this.recentAnimations.length>this.maxRecentHistory&&this.recentAnimations.shift()}_onAnimationFinished(t){var n;(n=this.onAnimationEnd)==null||n.call(this,this.currentAnimation),this.currentScenario===ie.IDLE&&this._selectSmartIdle()}update(t){if(!this.isInitialized)return;this.mixer&&this.mixer.update(t);const n=Date.now();if(this.currentScenario===ie.IDLE&&n-this.lastIdleCycleTime>this.idleCycleDuration){this.lastIdleCycleTime=n,this.idleCycleDuration=25e3+Math.random()*15e3;const e=this._selectSmartIdle();e&&e.name!==this.currentAnimation&&this.playAnimation(e.name,{priority:ze.LOW})}}getState(){return{currentAnimation:this.currentAnimation,currentScenario:this.currentScenario,isPlaying:this.isPlaying,loadedCount:this.loadedAnimations.size,recentAnimations:[...this.recentAnimations]}}pause(){if(this.currentAnimation){const t=this.loadedAnimations.get(this.currentAnimation);t!=null&&t.action&&(t.action.paused=!0)}this.isPlaying=!1}resume(){if(this.currentAnimation){const t=this.loadedAnimations.get(this.currentAnimation);t!=null&&t.action&&(t.action.paused=!1)}this.isPlaying=!0}dispose(){this.pause(),this.mixer&&(this.mixer.stopAllAction(),this.mixer=null),this.loadedAnimations.clear(),this.loadingPromises.clear(),this.vrm=null,this.isInitialized=!1,console.log("[AdvancedAnimationEngine] Disposed")}}class Mn{constructor(t){this.parser=t}get name(){return"VRMC_vrm_animation"}async afterRoot(t){var l;const n=t.parser.json,e=n.extensionsUsed;if(!e||!e.includes(this.name))return;const o=(l=n.extensions)==null?void 0:l[this.name];if(!o)return;const s=this._createNodeMap(o),a=t.animations.map((h,d)=>{const m=n.animations[d];return this._parseAnimation(h,m,s)});t.userData.vrmAnimations=a}_createNodeMap(t){var o;const n=new Map,e=(o=t.humanoid)==null?void 0:o.humanBones;return e&&Object.entries(e).forEach(([s,r])=>{const a=r==null?void 0:r.node;a!=null&&n.set(a,s)}),{humanoidIndexToName:n}}_parseAnimation(t,n,e){const o=t.tracks,s=n.channels,r={duration:t.duration,humanoidTracks:{translation:new Map,rotation:new Map}};return s.forEach((a,l)=>{const{node:h,path:d}=a.target,m=o[l];if(!m)return;const y=e.humanoidIndexToName.get(h);y&&(d==="rotation"?r.humanoidTracks.rotation.set(y,m):d==="translation"&&r.humanoidTracks.translation.set(y,m))}),r}}let qe=null;function wn(){return qe||(qe=new bn),qe}Vt(Ht);let Qe=null,Je=null,et=null;const vn=async()=>{if(!Qe||!Je){const c=await Ve(()=>import("./three-vrm.module-Bgvs_-Yu.js"),__vite__mapDeps([4,1,2,3]),import.meta.url);Qe=c.VRMLoaderPlugin,Je=c.VRMUtils}return et||(et=(await Ve(()=>import("./GLTFLoader-QrdB9JU-.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)).GLTFLoader),{VRMLoaderPlugin:Qe,VRMUtils:Je,GLTFLoader:et}},Pn=({url:c,scale:t=1,position:n=[0,0,0],enableLookAt:e=!0,enableBlink:o=!0,expression:s="neutral",isSpeaking:r=!1,onLoad:a,onError:l})=>{const[h,d]=f.useState(null),[m,y]=f.useState(!0),{camera:M,mouse:w,size:L}=oe();f.useRef(new yt);const R=f.useRef(0),H=f.useRef(0);f.useRef(null);const F=f.useRef(Gt()),U=f.useRef(pn()),V=f.useRef(yn()),E=f.useRef(wn()),A=f.useRef(null),K=f.useRef(0),Y=f.useRef(0),v=f.useRef([]),b=f.useRef(0),O=f.useRef(!1);f.useEffect(()=>{let P=!0;return(async()=>{try{const{VRMLoaderPlugin:T,VRMUtils:N,GLTFLoader:_}=await vn(),z=new _;z.crossOrigin="anonymous",z.register(S=>new T(S,{autoUpdateHumanBones:!0})),z.load(c,S=>{var j;if(!P)return;const C=S.userData.vrm;if(C){if(N.removeUnnecessaryVertices(S.scene),N.combineSkeletons(S.scene),N.combineMorphs(C),C.scene.traverse($=>{$.frustumCulled=!1}),C.scene.rotation.y=Math.PI,U.current){const $=U.current;$.initialize(C),console.log("[OptimizedVRMModel] VRMA animation service initialized"),$.setState("idle").then(J=>{J?(console.log("[OptimizedVRMModel]  Idle animation started successfully"),console.log("[OptimizedVRMModel] Animation state:",$.getState())):console.warn("[OptimizedVRMModel]  Failed to start idle animation")}).catch(J=>{console.error("[OptimizedVRMModel]  Error starting idle animation:",J)})}console.log("VRM loaded:",((j=C.meta)==null?void 0:j.name)||c),d(C),a==null||a(C)}else console.error("No VRM data found in model"),l==null||l(new Error("No VRM data found"));y(!1)},S=>{S.total>0&&console.log(`Loading VRM: ${(S.loaded/S.total*100).toFixed(1)}%`)},S=>{console.error("VRM load error:",S),l==null||l(S),y(!1)})}catch(T){console.error("Failed to load VRM deps:",T),y(!1)}})(),()=>{P=!1,U.current&&(U.current.dispose(),console.log("[OptimizedVRMModel] Animation service disposed for model change"))}},[c]),f.useEffect(()=>{if(h&&V.current){V.current.initialize(),console.log("[OptimizedVRMModel] MouseInteractionService initialized");const P=V.current.onInteraction(D=>{console.log("[OptimizedVRMModel] Interaction:",D.type),D.type==="headPat"&&gt.triggerReaction("head")});return()=>{var D;P(),(D=V.current)==null||D.stop()}}},[h]),ot((P,D)=>{var S;if(!h)return;H.current++;const T=D;h.update(T);const N=F.current;N.update(T);const _=N.getState(),z=U.current;if(z){if(z.update(T),_!==A.current){A.current=_;const j={[G.IDLE]:"idle",[G.SPEAKING]:"speaking",[G.DANCING]:"dancing",[G.SLEEPING]:"sleeping",[G.DRAGGING]:"dragging",[G.SITTING_TASKBAR]:"sitting",[G.SITTING_WINDOW]:"sitting",[G.THINKING]:"thinking",[G.HAPPY]:"happy",[G.EXCITED]:"happy",[G.SAD]:"idle",[G.EMBARRASSED]:"idle"}[_]||"idle";console.log(`[OptimizedVRMModel] State changed: ${_} -> animation: ${j}`),z.setState(j).catch($=>{console.warn("[OptimizedVRMModel] Failed to set animation state:",$)})}_===G.IDLE?(K.current+=T,K.current>30+Math.random()*30&&(K.current=0,Math.random()<.4&&z.playRandomGesture())):K.current=0}if(o&&_!==G.SLEEPING&&(R.current+=T,R.current>3+Math.random()*4&&(R.current=0,(S=h.expressionManager)!=null&&S.getExpression("blink")&&(h.expressionManager.setValue("blink",1),setTimeout(()=>{var j;(j=h.expressionManager)==null||j.setValue("blink",0)},100)))),r&&h.expressionManager){const C=.3+Math.sin(P.clock.elapsedTime*15)*.2;h.expressionManager.setValue("aa",C),_!==G.SPEAKING&&N.setState(G.SPEAKING)}else h.expressionManager&&(h.expressionManager.setValue("aa",0),_===G.SPEAKING&&N.setState(G.IDLE));_===G.SLEEPING&&h.expressionManager&&h.expressionManager.setValue("blink",1)});const we=f.useCallback(P=>{var N,_;if(!h)return;const D=Date.now(),T=D-Y.current;Y.current=D,T<300?(N=E.current)==null||N.handleInteraction(ce.DOUBLE_CLICK):(_=E.current)==null||_.handleInteraction(ce.CLICK),gt.handleTouch(P,h)},[h]),q=f.useCallback(()=>{var P;(P=E.current)==null||P.handleInteraction(ce.HOVER)},[]),fe=f.useCallback(P=>{var T;const D=Date.now();if(D-b.current>100&&(b.current=D,P.point&&P.point.y>1.2)){v.current.push(P.point.x),v.current.length>5&&v.current.shift();let N=0;for(let _=2;_<v.current.length;_++){const z=v.current[_-1]-v.current[_-2],S=v.current[_]-v.current[_-1];Math.sign(z)!==Math.sign(S)&&N++}N>=2&&!O.current&&(O.current=!0,console.log("[OptimizedVRMModel] Head Pat Detected! "),(T=V.current)==null||T.triggerEvent("headPat"),setTimeout(()=>{O.current=!1},1e3))}},[]);return m?Q.jsx(Qt,{center:!0,children:Q.jsx("div",{className:"text-white text-sm animate-pulse",children:"Loading..."})}):h?Q.jsx("primitive",{object:h.scene,scale:t,position:n,onClick:we,onPointerOver:q,onPointerMove:fe}):null},Nn=({modelUrl:c,size:t={width:200,height:300},expression:n="neutral",isSpeaking:e=!1,isThinking:o=!1,enableInteraction:s=!0,quality:r="medium",onLoad:a,onError:l})=>{const[h,d]=f.useState(!1),m=f.useMemo(()=>({low:{pixelRatio:.75,antialias:!0,shadows:!1},medium:{pixelRatio:1,antialias:!0,shadows:!1},high:{pixelRatio:1.5,antialias:!0,shadows:!0}}),[]),y=m[r]||m.high,M=f.useCallback(w=>{d(!0),a==null||a(w)},[a]);return Q.jsxs("div",{style:{width:t.width,height:t.height},className:"relative",children:[Q.jsxs(jt,{camera:{position:[0,.8,3],fov:50},dpr:y.pixelRatio,gl:{antialias:y.antialias,alpha:!0,powerPreference:"high-performance",preserveDrawingBuffer:!0},style:{background:"transparent"},frameloop:"always",children:[Q.jsx("ambientLight",{intensity:.8}),Q.jsx("directionalLight",{position:[5,5,5],intensity:.7}),Q.jsx("directionalLight",{position:[-5,3,-5],intensity:.3}),Q.jsx(Pn,{url:c,scale:1,expression:n,isSpeaking:e,onLoad:M,onError:l},c),s&&Q.jsx(ln,{enableZoom:!1,enablePan:!1,enableRotate:!1,target:[0,1,0]})]},c),o&&Q.jsx("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 text-lg animate-bounce",children:""})]})};export{Pn as OptimizedVRMModel,Nn as default};
